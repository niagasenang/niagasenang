<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Komitmen Bulanan (Fixed) | NiagaSenang</title>
  <meta name="description" content="Senarai komitmen bulanan (duit wajib bayar) untuk micro traders. Auto kira total fixed bulanan. Offline-first. Export/Import backup.">

  <link rel="stylesheet" href="css/style.css">

  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-P81GM8SJWX"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-P81GM8SJWX');
  </script>

  <style>
    .grid-2{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    .grid-3{ display:grid; grid-template-columns:1.2fr 1fr 1fr; gap:12px; }
    .small{ font-size:12px; color:#64748b; }
    .muted{ color:#64748b; font-size:13px; }

    .box{
      background:#f8fafc;
      border:1px solid #e5e7eb;
      border-radius:12px;
      padding:12px;
      margin-top:12px;
    }

    table{ width:100%; border-collapse:collapse; margin-top:12px; }
    th, td{ padding:10px 8px; border-bottom:1px solid #e5e7eb; font-size:14px; vertical-align:top; }
    th{ text-align:left; background:#f8fafc; font-size:13px; }
    .right{ text-align:right; }

    .pill{
      display:inline-block;
      padding:4px 10px;
      border-radius:999px;
      font-size:12px;
      border:1px solid #e5e7eb;
      background:#fff;
      line-height:1.2;
      font-weight:800;
      color:#334155;
    }
    .pill-ok{
      background: rgba(4,120,87,.10);
      border-color: rgba(4,120,87,.25);
      color:#047857;
    }
    .pill-warn{
      background: rgba(245,158,11,.12);
      border-color: rgba(245,158,11,.25);
      color:#b45309;
    }
    .pill-bad{
      background: rgba(185,28,28,.10);
      border-color: rgba(185,28,28,.25);
      color:#b91c1c;
    }

    .actions{ display:flex; gap:8px; justify-content:flex-end; flex-wrap:wrap; }
    .mini-btn{
      padding:8px 10px;
      border-radius:10px;
      border:1px solid #e5e7eb;
      background:#fff;
      cursor:pointer;
      font-weight:700;
      font-size:12px;
    }
    .mini-btn:hover{ background:#f8fafc; }
    .danger{ border-color: rgba(239,68,68,0.35); color:#b91c1c; }
    .danger:hover{ background: rgba(239,68,68,0.08); }

    /* Language toggle (same style as ledger/index) */
    .top-row{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .lang-toggle{
      display:flex;
      gap:6px;
      padding:4px;
      border:1px solid #e5e7eb;
      border-radius:999px;
      background:#ffffff;
      flex:0 0 auto;
      margin-top:2px;
    }
    .lang-btn{
      border:0;
      background:transparent;
      padding:6px 10px;
      border-radius:999px;
      font-weight:800;
      font-size:12px;
      cursor:pointer;
      color:#334155;
      line-height:1;
    }
    .lang-btn.active{
      background:#1e293b;
      color:#ffffff;
    }

    /* Print */
    .print-header{
      display:none;
      margin-bottom:12px;
      padding-bottom:10px;
      border-bottom:1px solid #e5e7eb;
    }
    .print-header h1{ margin:0; font-size:18px; letter-spacing:.2px; }
    .print-meta{
      margin-top:6px;
      font-size:12px;
      color:#334155;
      display:flex;
      flex-wrap:wrap;
      gap:14px;
    }
    .print-meta span{
      display:inline-block;
      padding:4px 8px;
      border:1px solid #e5e7eb;
      border-radius:999px;
      background:#f8fafc;
    }

    @media print{
      .btn, .btn-secondary, button, input, select, textarea, a[href="index.html"], a[href="cashflow.html"], #importFile, .lang-toggle { display:none !important; }
      body { background:#fff !important; }
      .card { box-shadow:none !important; border:0 !important; }
      .print-header { display:block !important; }
      th, td { font-size:12px; padding:6px; }
      thead { display: table-header-group; }
      tr { page-break-inside: avoid; }
      .container { max-width: 100% !important; }
    }
  </style>
</head>

<body>
<div class="container">
<div class="card">

  <!-- PRINT ONLY HEADER -->
  <div class="print-header">
    <h1 id="phTitle">NiagaSenang ‚Äî Komitmen Bulanan (Fixed)</h1>
    <div class="print-meta">
      <span id="phBiz">Bisnes: -</span>
      <span id="phPrinted">Dicetak: -</span>
    </div>
  </div>

  <div class="top-row">
    <div>
      <h2 data-i18n="pageH2">üß∑ Komitmen Bulanan (Duit Wajib Bayar)</h2>
      <p class="small" data-i18n="pageIntro">
        Ini ialah kos yang <strong>confirm keluar</strong> setiap bulan (contoh sewa, bil, gaji, loan).
        Tool ini bantu kau nampak ‚Äúminimum duit masuk‚Äù supaya bisnes tak mati.
      </p>
    </div>

    <div class="lang-toggle" aria-label="Language toggle">
      <button type="button" class="lang-btn" data-lang="ms">BM</button>
      <button type="button" class="lang-btn" data-lang="en">EN</button>
    </div>
  </div>

  <hr style="margin:14px 0;">

  <!-- QUICK PRESETS -->
  <div class="box">
    <h3 style="margin:0 0 8px 0;" data-i18n="presetTitle">‚ö° Quick Add (preset)</h3>
    <p class="muted" style="margin:0 0 10px 0;" data-i18n="presetIntro">
      Klik untuk tambah template. Kau boleh edit selepas tu.
    </p>
    <div style="display:flex; gap:10px; flex-wrap:wrap;">
      <button class="btn-secondary" type="button" onclick="addPreset('shop')" data-i18n="presetShop">üè™ Kedai</button>
      <button class="btn-secondary" type="button" onclick="addPreset('home')" data-i18n="presetHome">üè† Home Biz</button>
      <button class="btn-secondary" type="button" onclick="addPreset('online')" data-i18n="presetOnline">üì¶ Online</button>
      <button class="btn-secondary" type="button" onclick="addPreset('clear')" data-i18n="presetClear">üßπ Clear Semua</button>
    </div>
    <p class="small" style="margin-top:8px;" data-i18n="presetNote">
      Tip: Komitmen ni ‚Äúrecurring‚Äù. Kalau ada item sekali-sekala, masukkan dalam Ledger sebagai expense biasa.
    </p>
  </div>

  <!-- ADD / EDIT FORM -->
  <div class="box">
    <h3 style="margin:0 0 10px 0;" data-i18n="addTitle">‚ûï Tambah Komitmen</h3>

    <div class="grid-3">
      <div>
        <label data-i18n="labelName">Nama Komitmen</label>
        <input id="name" placeholder="Contoh: Sewa Kedai">
      </div>

      <div>
        <label data-i18n="labelAmount">Jumlah (RM / bulan)</label>
        <input id="amount" type="number" step="0.01" placeholder="0.00">
      </div>

      <div>
        <label data-i18n="labelGroup">Kategori (optional)</label>
        <select id="group">
          <option value="Rent" id="grpRent">Rent</option>
          <option value="Utilities" id="grpUtilities">Utilities</option>
          <option value="Internet" id="grpInternet">Internet</option>
          <option value="Staff" id="grpStaff">Staff</option>
          <option value="Loan" id="grpLoan">Loan</option>
          <option value="Other" id="grpOther">Other</option>
        </select>
      </div>
    </div>

    <div class="grid-2" style="margin-top:12px;">
      <div>
        <label data-i18n="labelStatus">Status</label>
        <select id="active">
          <option value="1" id="optActive">Aktif</option>
          <option value="0" id="optInactive">Tidak Aktif</option>
        </select>
        <div class="small" data-i18n="statusHint">Kalau stop sementara, tukar jadi Tidak Aktif (tak masuk total).</div>
      </div>

      <div>
        <label data-i18n="labelNote">Nota (optional)</label>
        <input id="note" placeholder="Contoh: due setiap 1hb">
      </div>
    </div>

    <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
      <button class="btn" type="button" onclick="saveItem()" data-i18n="btnSave">Simpan</button>
      <button class="btn-secondary" type="button" onclick="resetForm()" data-i18n="btnReset">Reset</button>
    </div>

    <input type="hidden" id="editingId" value="">
  </div>

  <!-- SUMMARY -->
  <div class="box">
    <h3 style="margin:0 0 10px 0;" data-i18n="summaryTitle">üìå Ringkasan</h3>
    <div class="grid-3">
      <div>
        <div class="small" data-i18n="sumActiveLabel">Total Komitmen Aktif</div>
        <strong>RM <span id="sumFixed">0.00</span></strong>
      </div>
      <div>
        <div class="small" data-i18n="sumCountLabel">Bilangan Item</div>
        <span class="pill" id="countPill">0</span>
      </div>
      <div>
        <div class="small" data-i18n="sumLevelLabel">Survival Level</div>
        <span class="pill pill-warn" id="levelPill">-</span>
        <div class="small" style="margin-top:6px;" data-i18n="sumLevelHint">
          Lagi tinggi komitmen, lagi ketat cashflow. Gunakan Cashflow page untuk lihat bulan semasa.
        </div>
      </div>
    </div>
  </div>

  <!-- TABLE -->
  <h3 style="margin-top:18px;" data-i18n="tableTitle">üìÑ Senarai Komitmen</h3>
  <table>
    <thead>
      <tr>
        <th data-i18n="thName">Nama</th>
        <th data-i18n="thGroup">Kategori</th>
        <th data-i18n="thStatus">Status</th>
        <th data-i18n="thNote">Nota</th>
        <th class="right" data-i18n="thAmount">RM/Bulan</th>
        <th class="right" data-i18n="thAction">Actions</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <!-- BACKUP / PRINT / NAV -->
  <div style="margin-top:14px;">
    <button class="btn-secondary" type="button" onclick="exportData()" data-i18n="btnExport">‚¨á Export Backup</button>
    <input type="file" id="importFile" accept="application/json" style="display:none">
    <button class="btn-secondary" type="button" onclick="document.getElementById('importFile').click()" data-i18n="btnImport">‚¨Ü Import Backup</button>
    <button class="btn-secondary" type="button" onclick="printPage()" data-i18n="btnPrint">üñ® Print</button>
    <a class="btn-secondary" href="cashflow.html" style="text-decoration:none; display:inline-block;" data-i18n="btnCashflow">‚Üí Pergi Cashflow</a>
  </div>

  <p class="small" style="margin-top:16px;" data-i18n="disclaimer">
    Nota: Ini bukan ‚Äúliability accounting‚Äù. Ini list komitmen bulanan untuk bantu survival cashflow (micro traders).
  </p>

  <p style="margin-top:16px;">
    <a href="index.html" data-i18n="backLink">‚Üê Kembali ke NiagaSenang</a>
  </p>

</div>
</div>

<script>
/* =======================
   Keys (shared)
======================= */
const LANG_KEY = "ns_lang";
const KEY = "ns_commit_v1"; // commitments list
let CURRENT_LANG = "ms";

/* =======================
   i18n
======================= */
const I18N = {
  ms: {
    docTitle: "Komitmen Bulanan (Fixed) | NiagaSenang",
    pageH2: "üß∑ Komitmen Bulanan (Duit Wajib Bayar)",
    pageIntro: "Ini ialah kos yang <strong>confirm keluar</strong> setiap bulan (contoh sewa, bil, gaji, loan). Tool ini bantu kau nampak ‚Äúminimum duit masuk‚Äù supaya bisnes tak mati.",

    presetTitle: "‚ö° Quick Add (preset)",
    presetIntro: "Klik untuk tambah template. Kau boleh edit selepas tu.",
    presetShop: "üè™ Kedai",
    presetHome: "üè† Home Biz",
    presetOnline: "üì¶ Online",
    presetClear: "üßπ Clear Semua",
    presetNote: "Tip: Komitmen ni ‚Äúrecurring‚Äù. Kalau ada item sekali-sekala, masukkan dalam Ledger sebagai expense biasa.",

    addTitle: "‚ûï Tambah Komitmen",
    labelName: "Nama Komitmen",
    labelAmount: "Jumlah (RM / bulan)",
    labelGroup: "Kategori (optional)",
    labelStatus: "Status",
    labelNote: "Nota (optional)",
    statusHint: "Kalau stop sementara, tukar jadi Tidak Aktif (tak masuk total).",

    optActive: "Aktif",
    optInactive: "Tidak Aktif",

    summaryTitle: "üìå Ringkasan",
    sumActiveLabel: "Total Komitmen Aktif",
    sumCountLabel: "Bilangan Item",
    sumLevelLabel: "Survival Level",
    sumLevelHint: "Lagi tinggi komitmen, lagi ketat cashflow. Gunakan Cashflow page untuk lihat bulan semasa.",

    tableTitle: "üìÑ Senarai Komitmen",
    thName: "Nama",
    thGroup: "Kategori",
    thStatus: "Status",
    thNote: "Nota",
    thAmount: "RM/Bulan",
    thAction: "Actions",

    btnSave: "Simpan",
    btnReset: "Reset",
    btnExport: "‚¨á Export Backup",
    btnImport: "‚¨Ü Import Backup",
    btnPrint: "üñ® Print",
    btnCashflow: "‚Üí Pergi Cashflow",
    backLink: "‚Üê Kembali ke NiagaSenang",

    disclaimer: "Nota: Ini bukan ‚Äúliability accounting‚Äù. Ini list komitmen bulanan untuk bantu survival cashflow (micro traders).",

    grpRent:"Rent", grpUtilities:"Utilities", grpInternet:"Internet", grpStaff:"Staff", grpLoan:"Loan", grpOther:"Other",

    placeholderName: "Contoh: Sewa Kedai",
    placeholderNote: "Contoh: due setiap 1hb",

    alertNeedName: "Isi nama komitmen.",
    alertNeedAmt: "Masukkan jumlah (lebih dari 0).",
    alertImportOk: "‚úÖ Backup berjaya diimport!",
    alertImportFail: "‚ùå Import gagal. Pastikan fail backup commitment yang betul.",
    confirmClear: "Confirm nak clear semua komitmen?",
    levelLow: "Low Commitment",
    levelMed: "Moderate",
    levelHigh: "High Commitment",
    statusActive: "Aktif",
    statusInactive: "Tidak Aktif",
    editBtn: "Edit",
    delBtn: "Delete",
    confirmDel: "Delete item ni?"
  },

  en: {
    docTitle: "Monthly Commitments (Fixed) | NiagaSenang",
    pageH2: "üß∑ Monthly Commitments (Must-Pay Costs)",
    pageIntro: "These are costs that <strong>must be paid</strong> every month (rent, bills, salaries, loans). This helps you see the ‚Äúminimum money-in‚Äù to keep the business alive.",

    presetTitle: "‚ö° Quick Add (preset)",
    presetIntro: "Click to insert a template. You can edit after.",
    presetShop: "üè™ Shop",
    presetHome: "üè† Home Biz",
    presetOnline: "üì¶ Online",
    presetClear: "üßπ Clear All",
    presetNote: "Tip: These are recurring commitments. One-off costs should go into Ledger as normal expenses.",

    addTitle: "‚ûï Add Commitment",
    labelName: "Commitment Name",
    labelAmount: "Amount (RM / month)",
    labelGroup: "Category (optional)",
    labelStatus: "Status",
    labelNote: "Note (optional)",
    statusHint: "If paused, set to Inactive (excluded from totals).",

    optActive: "Active",
    optInactive: "Inactive",

    summaryTitle: "üìå Summary",
    sumActiveLabel: "Total Active Commitments",
    sumCountLabel: "Item Count",
    sumLevelLabel: "Survival Level",
    sumLevelHint: "Higher commitments = tighter cashflow. Use Cashflow page to see the current month.",

    tableTitle: "üìÑ Commitments List",
    thName: "Name",
    thGroup: "Category",
    thStatus: "Status",
    thNote: "Note",
    thAmount: "RM/Month",
    thAction: "Actions",

    btnSave: "Save",
    btnReset: "Reset",
    btnExport: "‚¨á Export Backup",
    btnImport: "‚¨Ü Import Backup",
    btnPrint: "üñ® Print",
    btnCashflow: "‚Üí Go to Cashflow",
    backLink: "‚Üê Back to NiagaSenang",

    disclaimer: "Note: This is not liability accounting. It‚Äôs a monthly commitments list for survival cashflow (micro traders).",

    grpRent:"Rent", grpUtilities:"Utilities", grpInternet:"Internet", grpStaff:"Staff", grpLoan:"Loan", grpOther:"Other",

    placeholderName: "Example: Shop Rent",
    placeholderNote: "Example: due every 1st",

    alertNeedName: "Enter a commitment name.",
    alertNeedAmt: "Enter an amount (greater than 0).",
    alertImportOk: "‚úÖ Backup imported!",
    alertImportFail: "‚ùå Import failed. Please upload a valid commitments backup file.",
    confirmClear: "Confirm clear all commitments?",
    levelLow: "Low Commitment",
    levelMed: "Moderate",
    levelHigh: "High Commitment",
    statusActive: "Active",
    statusInactive: "Inactive",
    editBtn: "Edit",
    delBtn: "Delete",
    confirmDel: "Delete this item?"
  }
};

function t(key){
  const pack = I18N[CURRENT_LANG] || I18N.ms;
  return (pack[key] != null) ? pack[key] : (I18N.ms[key] ?? "");
}

/* =======================
   Helpers
======================= */
function money(n){ return Number(n || 0).toFixed(2); }
function nowReadable(){
  const d = new Date();
  const locale = (CURRENT_LANG === "en") ? "en-US" : "ms-MY";
  return d.toLocaleString(locale, { year:'numeric', month:'short', day:'2-digit', hour:'2-digit', minute:'2-digit' });
}
function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function makeId(){ return "cm_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16); }

/* =======================
   Storage
======================= */
function load(){
  try{
    const v = JSON.parse(localStorage.getItem(KEY) || "[]");
    return Array.isArray(v) ? v : [];
  }catch(e){
    return [];
  }
}
function save(items){ localStorage.setItem(KEY, JSON.stringify(items)); }

/* =======================
   Language
======================= */
function detectBrowserLang(){
  const nav = (navigator.language || "").toLowerCase();
  return nav.startsWith("en") ? "en" : "ms";
}
function applyLang(lang){
  CURRENT_LANG = (lang === "en") ? "en" : "ms";
  localStorage.setItem(LANG_KEY, CURRENT_LANG);

  document.querySelectorAll(".lang-btn").forEach(btn => {
    btn.classList.toggle("active", btn.dataset.lang === CURRENT_LANG);
  });

  document.documentElement.setAttribute("lang", CURRENT_LANG === "en" ? "en" : "ms");
  document.title = t("docTitle");

  document.querySelectorAll("[data-i18n]").forEach(el => {
    const key = el.getAttribute("data-i18n");
    const val = t(key);
    if(val != null && val !== "") el.innerHTML = val;
  });

  // placeholders
  document.getElementById("name").placeholder = t("placeholderName");
  document.getElementById("note").placeholder = t("placeholderNote");

  // group labels (optional; values remain same)
  document.getElementById("grpRent").textContent = t("grpRent");
  document.getElementById("grpUtilities").textContent = t("grpUtilities");
  document.getElementById("grpInternet").textContent = t("grpInternet");
  document.getElementById("grpStaff").textContent = t("grpStaff");
  document.getElementById("grpLoan").textContent = t("grpLoan");
  document.getElementById("grpOther").textContent = t("grpOther");

  document.getElementById("optActive").textContent = t("optActive");
  document.getElementById("optInactive").textContent = t("optInactive");

  // print header
  document.getElementById("phTitle").textContent = (CURRENT_LANG === "en")
    ? "NiagaSenang ‚Äî Monthly Commitments (Fixed)"
    : "NiagaSenang ‚Äî Komitmen Bulanan (Fixed)";

  render();
}

/* init lang */
(function(){
  const saved = localStorage.getItem(LANG_KEY);
  const start = saved || detectBrowserLang();
  applyLang(start);

  document.querySelectorAll(".lang-btn").forEach(btn => {
    btn.addEventListener("click", () => applyLang(btn.dataset.lang));
  });
})();

/* =======================
   Presets
======================= */
function presetData(type){
  if(type === "shop"){
    return [
      { name:"Sewa Kedai", amount:1500, group:"Rent", active:1, note:"" },
      { name:"Elektrik", amount:300, group:"Utilities", active:1, note:"" },
      { name:"Air", amount:60, group:"Utilities", active:1, note:"" },
      { name:"Unifi/Internet", amount:129, group:"Internet", active:1, note:"" }
    ];
  }
  if(type === "home"){
    return [
      { name:"Internet", amount:129, group:"Internet", active:1, note:"" },
      { name:"Elektrik", amount:120, group:"Utilities", active:1, note:"" },
      { name:"Ads/Marketing", amount:200, group:"Other", active:1, note:"" }
    ];
  }
  if(type === "online"){
    return [
      { name:"Ads/Marketing", amount:300, group:"Other", active:1, note:"" },
      { name:"Internet", amount:129, group:"Internet", active:1, note:"" },
      { name:"Platform Fee/Tools", amount:80, group:"Other", active:1, note:"" }
    ];
  }
  return [];
}

function addPreset(type){
  if(type === "clear"){
    if(!confirm(t("confirmClear"))) return;
    save([]);
    try { gtag('event', 'commitment_clear', { event_category:'accounting' }); } catch(e){}
    render();
    resetForm();
    return;
  }

  const items = load();
  const pack = presetData(type);
  const merged = [
    ...pack.map(x => ({
      id: makeId(),
      name: x.name,
      amount: Number(x.amount || 0),
      group: x.group || "Other",
      active: x.active ? 1 : 0,
      note: x.note || "",
      updatedAt: Date.now()
    })),
    ...items
  ];

  save(merged);
  try { gtag('event', 'commitment_preset', { event_category:'accounting', event_label: type }); } catch(e){}
  render();
}

/* =======================
   CRUD
======================= */
function resetForm(){
  editingId.value = "";
  name.value = "";
  amount.value = "";
  group.value = "Rent";
  active.value = "1";
  note.value = "";
  name.focus();
}

function saveItem(){
  const nm = (name.value || "").trim();
  const amt = Number(amount.value || 0);

  if(!nm) return alert(t("alertNeedName"));
  if(!amt || amt <= 0) return alert(t("alertNeedAmt"));

  const items = load();
  const id = (editingId.value || "").trim();

  const obj = {
    id: id || makeId(),
    name: nm,
    amount: amt,
    group: group.value || "Other",
    active: (active.value === "1") ? 1 : 0,
    note: (note.value || "").trim(),
    updatedAt: Date.now()
  };

  let next;
  if(id){
    next = items.map(x => (x.id === id ? obj : x));
  }else{
    next = [obj, ...items];
  }

  save(next);
  try { gtag('event', 'commitment_save', { event_category:'accounting' }); } catch(e){}
  render();
  resetForm();
}

function editItem(id){
  const it = load().find(x => x.id === id);
  if(!it) return;

  editingId.value = it.id;
  name.value = it.name || "";
  amount.value = it.amount != null ? String(it.amount) : "";
  group.value = it.group || "Other";
  active.value = it.active ? "1" : "0";
  note.value = it.note || "";

  window.scrollTo({ top: 0, behavior:"smooth" });
}

function deleteItem(id){
  if(!confirm(t("confirmDel"))) return;
  const next = load().filter(x => x.id !== id);
  save(next);
  try { gtag('event', 'commitment_delete', { event_category:'accounting' }); } catch(e){}
  render();
}

/* =======================
   Summary + Render
======================= */
function calc(items){
  const activeItems = items.filter(x => Number(x.active) === 1);
  const total = activeItems.reduce((s,x) => s + Number(x.amount || 0), 0);
  return { total, count: items.length, activeCount: activeItems.length };
}

function survivalLevel(totalFixed){
  // simple heuristic (micro traders):
  // < 1000 low, 1000-3000 moderate, >3000 high
  if(totalFixed <= 1000) return { cls:"pill-ok", text:t("levelLow") };
  if(totalFixed <= 3000) return { cls:"pill-warn", text:t("levelMed") };
  return { cls:"pill-bad", text:t("levelHigh") };
}

function render(){
  const items = load().slice().sort((a,b) => (b.updatedAt||0) - (a.updatedAt||0));
  const { total, count } = calc(items);

  sumFixed.textContent = money(total);
  countPill.textContent = String(count);

  const lvl = survivalLevel(total);
  levelPill.className = "pill " + lvl.cls;
  levelPill.textContent = lvl.text;

  // print header meta
  document.getElementById("phBiz").textContent = (CURRENT_LANG === "en") ? "Business: NiagaSenang (Local)" : "Bisnes: NiagaSenang (Local)";
  document.getElementById("phPrinted").textContent = ((CURRENT_LANG === "en") ? "Printed: " : "Dicetak: ") + nowReadable();

  tbody.innerHTML = items.length ? items.map(it => {
    const st = it.active ? t("statusActive") : t("statusInactive");
    const stPill = it.active ? "pill-ok" : "pill-warn";
    return `
      <tr>
        <td><strong>${escapeHtml(it.name || "-")}</strong></td>
        <td>${escapeHtml(it.group || "-")}</td>
        <td><span class="pill ${stPill}">${escapeHtml(st)}</span></td>
        <td>${escapeHtml(it.note || "-")}</td>
        <td class="right"><strong>${money(it.amount || 0)}</strong></td>
        <td class="right">
          <div class="actions">
            <button class="mini-btn" onclick="editItem('${it.id}')">${escapeHtml(t("editBtn"))}</button>
            <button class="mini-btn danger" onclick="deleteItem('${it.id}')">${escapeHtml(t("delBtn"))}</button>
          </div>
        </td>
      </tr>
    `;
  }).join("") : `
    <tr>
      <td colspan="6" class="muted" style="padding:14px;">
        ${(CURRENT_LANG === "en") ? "No commitments yet. Add one above üëÜ" : "Belum ada komitmen. Tambah item di atas üëÜ"}
      </td>
    </tr>
  `;
}

/* =======================
   Backup
======================= */
function exportData(){
  const payload = {
    app: "NiagaSenang Commitments (Fixed)",
    version: 1,
    exportedAt: new Date().toISOString(),
    data: load()
  };
  const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "niagasenang-commitments-backup.json";
  a.click();
  URL.revokeObjectURL(a.href);

  try { gtag('event', 'export_commitment', { event_category:'accounting' }); } catch(e){}
}

document.getElementById("importFile").addEventListener("change", e => {
  const file = e.target.files && e.target.files[0];
  if(!file) return;

  const r = new FileReader();
  r.onload = () => {
    try{
      const raw = JSON.parse(r.result);

      const arr = Array.isArray(raw) ? raw : (Array.isArray(raw.data) ? raw.data : null);
      if(!arr) throw new Error("bad format");

      const cleaned = arr.map(x => ({
        id: String(x.id || makeId()),
        name: String(x.name || "").trim(),
        amount: Number(x.amount || 0),
        group: String(x.group || "Other"),
        active: (Number(x.active) === 0) ? 0 : 1,
        note: String(x.note || ""),
        updatedAt: Number(x.updatedAt || Date.now())
      })).filter(x => x.name && x.amount > 0);

      save(cleaned);
      alert(t("alertImportOk"));
      try { gtag('event', 'import_commitment', { event_category:'accounting' }); } catch(e){}
      render();
    }catch(err){
      alert(t("alertImportFail"));
    }finally{
      e.target.value = "";
    }
  };
  r.readAsText(file);
});

/* =======================
   Print
======================= */
function printPage(){
  try { gtag('event', 'print_commitment', { event_category:'accounting' }); } catch(e){}
  render();
  window.print();
}

/* init */
resetForm();
render();
</script>

</body>
</html>