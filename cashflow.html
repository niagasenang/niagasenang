<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cashflow (Cash Basis) | NiagaSenang</title>
  <meta name="description" content="Cashflow cash basis percuma untuk peniaga Malaysia. Auto kira Net Cash In/Out, bulan/range, survival pill. Offline-first.">

  <link rel="stylesheet" href="css/style.css">

  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-P81GM8SJWX"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-P81GM8SJWX');
  </script>

  <style>
    .grid-2 { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    .grid-3 { display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px; }
    .small { font-size:12px; color:#64748b; }
    .muted { color:#64748b; font-size:13px; }

    .box{
      background:#f8fafc;
      border:1px solid #e5e7eb;
      border-radius:12px;
      padding:12px;
      margin-top:12px;
    }

    table { width:100%; border-collapse:collapse; margin-top:10px; }
    th, td { padding:8px; border-bottom:1px solid #e5e7eb; font-size:14px; vertical-align:top; }
    th { text-align:left; background:#f8fafc; font-size:13px; }
    .right { text-align:right; }

    .pill{
      display:inline-block;
      padding:4px 10px;
      border-radius:999px;
      font-size:12px;
      border:1px solid #e5e7eb;
      background:#f8fafc;
      line-height:1.2;
      font-weight:800;
    }
    .pill.ok{
      background: rgba(4,120,87,.10);
      border-color: rgba(4,120,87,.25);
      color:#047857;
    }
    .pill.warn{
      background: rgba(245,158,11,.12);
      border-color: rgba(245,158,11,.25);
      color:#b45309;
    }
    .pill.bad{
      background: rgba(185,28,28,.10);
      border-color: rgba(185,28,28,.25);
      color:#b91c1c;
    }
    .pill.neutral{
      background: rgba(100,116,139,.10);
      border-color: rgba(100,116,139,.25);
      color:#475569;
    }

    .incomeTxt { color:#047857; font-weight:800; }
    .expenseTxt { color:#b91c1c; font-weight:800; }

    /* ===== Top header row (title + language toggle) ===== */
    .top-row{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .lang-toggle{
      display:flex;
      gap:6px;
      padding:4px;
      border:1px solid #e5e7eb;
      border-radius:999px;
      background:#ffffff;
      flex:0 0 auto;
      margin-top:2px;
    }
    .lang-btn{
      border:0;
      background:transparent;
      padding:6px 10px;
      border-radius:999px;
      font-weight:800;
      font-size:12px;
      cursor:pointer;
      color:#334155;
      line-height:1;
    }
    .lang-btn.active{
      background:#1e293b;
      color:#ffffff;
    }

    /* Filter UI */
    .filter-row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:end;
      margin-top:10px;
    }
    .filter-row > div{ min-width: 160px; }
    .hint { font-size:12px; color:#64748b; margin-top:6px; }

    /* Month filter UI */
    .month-row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:end;
      margin-top:10px;
    }
    .month-row > div{ min-width: 160px; }

    /* Print */
    .print-header{
      display:none;
      margin-bottom:12px;
      padding-bottom:10px;
      border-bottom:1px solid #e5e7eb;
    }
    .print-header h1{
      margin:0;
      font-size:18px;
      letter-spacing:.2px;
    }
    .print-meta{
      margin-top:6px;
      font-size:12px;
      color:#334155;
      display:flex;
      flex-wrap:wrap;
      gap:14px;
    }
    .print-meta span{
      display:inline-block;
      padding:4px 8px;
      border:1px solid #e5e7eb;
      border-radius:999px;
      background:#f8fafc;
    }

    @media print{
      .btn, .btn-secondary, button, input, select, textarea,
      a[href="index.html"], .lang-toggle { display:none !important; }
      body { background:#fff !important; }
      .card { box-shadow:none !important; border:0 !important; }
      .print-header { display:block !important; }
      th, td { font-size:12px; padding:6px; }
      thead { display: table-header-group; }
      tr { page-break-inside: avoid; }
      .container { max-width: 100% !important; }
    }
  </style>
</head>

<body>
<div class="container">
<div class="card">

  <!-- PRINT ONLY HEADER -->
  <div class="print-header">
    <h1 id="phTitle">NiagaSenang ‚Äî Cashflow (Cash Basis)</h1>
    <div class="print-meta">
      <span id="phBiz">Bisnes: -</span>
      <span id="phPeriod">Tempoh: -</span>
      <span id="phPrinted">Dicetak: -</span>
    </div>
  </div>

  <!-- Top row: title + lang toggle -->
  <div class="top-row">
    <div>
      <h2 data-i18n="pageH2">üí∏ Cashflow ‚Äî Cash Basis</h2>
      <p class="small" data-i18n="pageIntro">
        Ringkasan aliran tunai dari <strong>Ledger</strong> (duit masuk/keluar).
        Fokus: ‚Äúbisnes hidup ke mati‚Äù ikut cash.
      </p>
    </div>

    <div class="lang-toggle" aria-label="Language toggle">
      <button type="button" class="lang-btn" data-lang="ms">BM</button>
      <button type="button" class="lang-btn" data-lang="en">EN</button>
    </div>
  </div>

  <hr style="margin:14px 0;">

  <!-- MONTH FILTER -->
  <div class="box">
    <h3 style="margin:0;" data-i18n="monthTitle">üóìÔ∏è Filter Bulan (cepat)</h3>

    <div class="month-row">
      <div>
        <label data-i18n="labelMonth">Bulan</label>
        <input type="month" id="monthPick">
        <div class="hint" data-i18n="monthHint">Tip: Pilih bulan untuk ringkas view cashflow.</div>
      </div>

      <div>
        <button class="btn-secondary" onclick="applyMonth()" data-i18n="btnApplyMonth">Apply Bulan</button>
        <button class="btn-secondary" onclick="resetMonth()" data-i18n="btnResetMonth">Reset Bulan</button>
      </div>
    </div>

    <div class="hint" id="monthHintTxt">Menunjukkan: Semua transaksi</div>
  </div>

  <!-- RANGE FILTER -->
  <div class="box">
    <h3 style="margin:0;" data-i18n="filterTitle">üóìÔ∏è Filter Tarikh (paparan &amp; print)</h3>

    <div class="filter-row">
      <div>
        <label data-i18n="labelRange">Range</label>
        <select id="rangePreset">
          <option value="all" id="rngAll">Semua</option>
          <option value="week" id="rngWeek">Minggu Ini</option>
          <option value="month" id="rngMonth">Bulan Ini</option>
          <option value="custom" id="rngCustom">Custom</option>
        </select>
      </div>

      <div>
        <label data-i18n="labelFrom">Dari</label>
        <input type="date" id="fromDate" disabled>
      </div>

      <div>
        <label data-i18n="labelTo">Hingga</label>
        <input type="date" id="toDate" disabled>
      </div>

      <div>
        <button class="btn-secondary" onclick="applyFilter()" data-i18n="btnApply">Apply</button>
        <button class="btn-secondary" onclick="resetFilter()" data-i18n="btnReset">Reset</button>
      </div>
    </div>

    <div class="hint" id="filterHint">Menunjukkan: Semua transaksi</div>
  </div>

  <!-- SUMMARY -->
  <div class="box">
    <h3 style="margin:0 0 10px 0;" data-i18n="summaryTitle">üìå Ringkasan Cashflow</h3>

    <div class="grid-3">
      <div>
        <div class="small" data-i18n="sumInLabel">Cash In</div>
        <strong class="incomeTxt">RM <span id="sumIn">0.00</span></strong>
      </div>
      <div>
        <div class="small" data-i18n="sumOutLabel">Cash Out</div>
        <strong class="expenseTxt">RM <span id="sumOut">0.00</span></strong>
      </div>
      <div>
        <div class="small" data-i18n="sumNetLabel">Net Cashflow</div>
        <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
          <strong>RM <span id="sumNet">0.00</span></strong>
          <span class="pill neutral" id="survivalPill">-</span>
        </div>
        <div class="small" style="margin-top:6px;">
          <span data-i18n="burnLabel">Burn / Day (avg):</span>
          <strong>RM <span id="burnPerDay">0.00</span></strong>
        </div>
      </div>
    </div>

    <p class="small" style="margin-top:10px;" data-i18n="summaryNote">
      Nota: ‚ÄúBurn/Day‚Äù dikira dari total cash out √∑ bilangan hari dalam tempoh filter.
      Ini bukan GAAP‚Äîini survival view.
    </p>
  </div>

  <!-- BREAKDOWN -->
  <div class="box">
    <h3 style="margin:0 0 10px 0;" data-i18n="breakdownTitle">üßæ Breakdown (ikut kategori)</h3>

    <div class="grid-2">
      <div>
        <h4 style="margin:0 0 6px 0;" data-i18n="incomeTitle">Cash In</h4>
        <table>
          <thead>
            <tr>
              <th data-i18n="thCategory">Kategori</th>
              <th class="right" data-i18n="thAmount">Jumlah (RM)</th>
            </tr>
          </thead>
          <tbody id="inRows"></tbody>
          <tfoot>
            <tr>
              <th data-i18n="footIn">Total Cash In</th>
              <th class="right incomeTxt">RM <span id="inTotalFoot">0.00</span></th>
            </tr>
          </tfoot>
        </table>
      </div>

      <div>
        <h4 style="margin:0 0 6px 0;" data-i18n="expenseTitle">Cash Out</h4>
        <table>
          <thead>
            <tr>
              <th data-i18n="thCategory2">Kategori</th>
              <th class="right" data-i18n="thAmount2">Jumlah (RM)</th>
            </tr>
          </thead>
          <tbody id="outRows"></tbody>
          <tfoot>
            <tr>
              <th data-i18n="footOut">Total Cash Out</th>
              <th class="right expenseTxt">RM <span id="outTotalFoot">0.00</span></th>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>

    <p class="small" style="margin-top:10px;" data-i18n="disclaimerText">
      Tool ini adalah cash basis survival view untuk kegunaan dalaman. Untuk compliance cukai, rujuk akauntan.
    </p>
  </div>

  <div style="margin-top:14px;">
    <button class="btn-secondary" onclick="printCF()" data-i18n="btnPrint">üñ® Print Cashflow (ikut filter)</button>

    <a class="btn-secondary" href="ledger.html" style="text-decoration:none; display:inline-block;" data-i18n="btnLedger">
      ‚Üê Pergi Ledger
    </a>

    <a class="btn-secondary" href="pl.html" style="text-decoration:none; display:inline-block;" data-i18n="btnPL">
      üìä Pergi P&amp;L
    </a>

    <a class="btn-secondary" href="commitment.html" style="text-decoration:none; display:inline-block;" data-i18n="btnCommitment">
      üìå Komitmen
    </a>
  </div>

  <p style="margin-top:16px;">
    <a href="index.html" data-i18n="backLink">‚Üê Kembali ke NiagaSenang</a>
  </p>

</div>
</div>

<script>
/* ===== storage keys ===== */
const LEDGER_KEY = "ns_ledger_v3";
const RANGE_FILTER_KEY = "ns_cashflow_filter_v1";   // date range filter
const MONTH_FILTER_KEY = "ns_cashflow_month_v1";    // month quick filter
const LANG_KEY = "ns_lang";

let CURRENT_LANG = "ms";

/* ===== i18n ===== */
const I18N = {
  ms: {
    docTitle: "Cashflow (Cash Basis) | NiagaSenang",
    phTitle: "NiagaSenang ‚Äî Cashflow (Cash Basis)",

    pageH2: "üí∏ Cashflow ‚Äî Cash Basis",
    pageIntro: "Ringkasan aliran tunai dari <strong>Ledger</strong> (duit masuk/keluar). Fokus: ‚Äúbisnes hidup ke mati‚Äù ikut cash.",

    monthTitle: "üóìÔ∏è Filter Bulan (cepat)",
    labelMonth: "Bulan",
    monthHint: "Tip: Pilih bulan untuk ringkas view cashflow.",
    btnApplyMonth: "Apply Bulan",
    btnResetMonth: "Reset Bulan",

    filterTitle: "üóìÔ∏è Filter Tarikh (paparan & print)",
    labelRange: "Range",
    labelFrom: "Dari",
    labelTo: "Hingga",
    btnApply: "Apply",
    btnReset: "Reset",
    rngAll: "Semua",
    rngWeek: "Minggu Ini",
    rngMonth: "Bulan Ini",
    rngCustom: "Custom",

    summaryTitle: "üìå Ringkasan Cashflow",
    sumInLabel: "Cash In",
    sumOutLabel: "Cash Out",
    sumNetLabel: "Net Cashflow",
    burnLabel: "Burn / Day (avg):",
    summaryNote: "Nota: ‚ÄúBurn/Day‚Äù dikira dari total cash out √∑ bilangan hari dalam tempoh filter. Ini bukan GAAP‚Äîini survival view.",

    breakdownTitle: "üßæ Breakdown (ikut kategori)",
    incomeTitle: "Cash In",
    expenseTitle: "Cash Out",
    thCategory: "Kategori",
    thAmount: "Jumlah (RM)",
    thCategory2: "Kategori",
    thAmount2: "Jumlah (RM)",
    footIn: "Total Cash In",
    footOut: "Total Cash Out",

    disclaimerText: "Tool ini adalah cash basis survival view untuk kegunaan dalaman. Untuk compliance cukai, rujuk akauntan.",

    btnPrint: "üñ® Print Cashflow (ikut filter)",
    btnLedger: "‚Üê Pergi Ledger",
    btnPL: "üìä Pergi P&L",
    btnCommitment: "üìå Komitmen",
    backLink: "‚Üê Kembali ke NiagaSenang",

    // dynamic
    showPrefix: "Menunjukkan: ",
    allTxns: "Semua transaksi",
    weekLabel: "Minggu ini",
    monthLabel: "Bulan ini",
    customLabel: "Custom",
    customFrom: "dari",
    customTo: "hingga",
    monthQuick: "Bulan dipilih",

    bizLabel: "Bisnes: ",
    periodLabel: "Tempoh: ",
    printedLabel: "Dicetak: ",

    alertCustomNeedDate: "Untuk Custom, sila pilih tarikh Dari / Hingga (sekurang-kurangnya satu).",

    // survival pills
    survHealthy: "Sihat",
    survOk: "OK",
    survWarning: "Warning",
    survCritical: "Kritikal",
    survNeutral: "Neutral"
  },

  en: {
    docTitle: "Cashflow (Cash Basis) | NiagaSenang",
    phTitle: "NiagaSenang ‚Äî Cashflow (Cash Basis)",

    pageH2: "üí∏ Cashflow ‚Äî Cash Basis",
    pageIntro: "Cashflow summary from your <strong>Ledger</strong> (money in/out). Focus: ‚Äúis the business alive?‚Äù in cash terms.",

    monthTitle: "üóìÔ∏è Monthly Filter (quick)",
    labelMonth: "Month",
    monthHint: "Tip: Pick a month for a quick cashflow view.",
    btnApplyMonth: "Apply Month",
    btnResetMonth: "Reset Month",

    filterTitle: "üóìÔ∏è Date Filter (view & print)",
    labelRange: "Range",
    labelFrom: "From",
    labelTo: "To",
    btnApply: "Apply",
    btnReset: "Reset",
    rngAll: "All",
    rngWeek: "This Week",
    rngMonth: "This Month",
    rngCustom: "Custom",

    summaryTitle: "üìå Cashflow Summary",
    sumInLabel: "Cash In",
    sumOutLabel: "Cash Out",
    sumNetLabel: "Net Cashflow",
    burnLabel: "Burn / Day (avg):",
    summaryNote: "Note: ‚ÄúBurn/Day‚Äù is calculated as total cash out √∑ number of days in the filtered period. This is a survival view, not GAAP.",

    breakdownTitle: "üßæ Breakdown (by category)",
    incomeTitle: "Cash In",
    expenseTitle: "Cash Out",
    thCategory: "Category",
    thAmount: "Amount (RM)",
    thCategory2: "Category",
    thAmount2: "Amount (RM)",
    footIn: "Total Cash In",
    footOut: "Total Cash Out",

    disclaimerText: "This is a cash-basis survival view for internal use. For tax compliance, consult an accountant.",

    btnPrint: "üñ® Print Cashflow (filtered)",
    btnLedger: "‚Üê Go to Ledger",
    btnPL: "üìä Go to P&L",
    btnCommitment: "üìå Commitments",
    backLink: "‚Üê Back to NiagaSenang",

    // dynamic
    showPrefix: "Showing: ",
    allTxns: "All transactions",
    weekLabel: "This week",
    monthLabel: "This month",
    customLabel: "Custom",
    customFrom: "from",
    customTo: "to",
    monthQuick: "Selected month",

    bizLabel: "Business: ",
    periodLabel: "Period: ",
    printedLabel: "Printed: ",

    alertCustomNeedDate: "For Custom, choose From/To dates (at least one).",

    // survival pills
    survHealthy: "Healthy",
    survOk: "OK",
    survWarning: "Warning",
    survCritical: "Critical",
    survNeutral: "Neutral"
  }
};

function t(key){
  const pack = I18N[CURRENT_LANG] || I18N.ms;
  return (pack[key] != null) ? pack[key] : (I18N.ms[key] ?? "");
}

/* ===== helpers ===== */
function today(){ return new Date().toISOString().slice(0,10); }
function money(n){ return Number(n || 0).toFixed(2); }

function nowReadable(){
  const d = new Date();
  const locale = (CURRENT_LANG === "en") ? "en-US" : "ms-MY";
  return d.toLocaleString(locale, { year:'numeric', month:'short', day:'2-digit', hour:'2-digit', minute:'2-digit' });
}

function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/* ===== language ===== */
function detectBrowserLang(){
  const nav = (navigator.language || "").toLowerCase();
  return nav.startsWith("en") ? "en" : "ms";
}

function applyLang(lang){
  CURRENT_LANG = (lang === "en") ? "en" : "ms";
  localStorage.setItem(LANG_KEY, CURRENT_LANG);

  document.querySelectorAll(".lang-btn").forEach(btn => {
    btn.classList.toggle("active", btn.dataset.lang === CURRENT_LANG);
  });

  document.documentElement.setAttribute("lang", CURRENT_LANG === "en" ? "en" : "ms");
  document.title = t("docTitle");

  document.querySelectorAll("[data-i18n]").forEach(el => {
    const key = el.getAttribute("data-i18n");
    const val = t(key);
    if (val != null && val !== "") el.innerHTML = val;
  });

  const phTitle = document.getElementById("phTitle");
  if(phTitle) phTitle.textContent = t("phTitle");

  // update dropdown option labels
  const rngAll = document.getElementById("rngAll");
  const rngWeek = document.getElementById("rngWeek");
  const rngMonth = document.getElementById("rngMonth");
  const rngCustom = document.getElementById("rngCustom");
  if(rngAll) rngAll.textContent = t("rngAll");
  if(rngWeek) rngWeek.textContent = t("rngWeek");
  if(rngMonth) rngMonth.textContent = t("rngMonth");
  if(rngCustom) rngCustom.textContent = t("rngCustom");

  render();
}

(function initLang(){
  const saved = localStorage.getItem(LANG_KEY);
  applyLang(saved || detectBrowserLang());

  document.querySelectorAll(".lang-btn").forEach(btn => {
    btn.addEventListener("click", () => applyLang(btn.dataset.lang));
  });
})();

/* ===== ledger load ===== */
function loadLedger(){
  try{
    const v = JSON.parse(localStorage.getItem(LEDGER_KEY) || "[]");
    return Array.isArray(v) ? v : [];
  }catch(e){
    return [];
  }
}

/* ===== date helpers ===== */
function startOfWeekISO(d){
  const date = new Date(d);
  const day = date.getDay(); // 0 Sun..6 Sat
  const diff = (day === 0 ? -6 : 1 - day); // Monday start
  date.setDate(date.getDate() + diff);
  return date.toISOString().slice(0,10);
}
function endOfWeekISO(d){
  const start = new Date(startOfWeekISO(d));
  start.setDate(start.getDate() + 6);
  return start.toISOString().slice(0,10);
}
function startOfMonthISO(d){
  const date = new Date(d);
  date.setDate(1);
  return date.toISOString().slice(0,10);
}
function endOfMonthISO(d){
  const date = new Date(d);
  date.setMonth(date.getMonth() + 1);
  date.setDate(0);
  return date.toISOString().slice(0,10);
}
function daysBetweenISO(a, b){
  // inclusive days count
  const da = new Date(a + "T00:00:00");
  const db = new Date(b + "T00:00:00");
  const diff = Math.floor((db - da) / (1000*60*60*24));
  return Math.max(1, diff + 1);
}

/* ===== month filter state ===== */
function getMonthFilter(){
  try{
    const m = JSON.parse(localStorage.getItem(MONTH_FILTER_KEY) || "{}");
    return { month: m.month || "" }; // YYYY-MM
  }catch(e){
    return { month:"" };
  }
}
function setMonthFilter(m){ localStorage.setItem(MONTH_FILTER_KEY, JSON.stringify(m)); }

/* ===== range filter state ===== */
function getRangeFilter(){
  try{
    const f = JSON.parse(localStorage.getItem(RANGE_FILTER_KEY) || "{}");
    return { preset: f.preset || "all", from: f.from || "", to: f.to || "" };
  }catch(e){
    return { preset:"all", from:"", to:"" };
  }
}
function setRangeFilter(f){ localStorage.setItem(RANGE_FILTER_KEY, JSON.stringify(f)); }

function normalizeFilterFromUI(){
  const preset = rangePreset.value;
  let from = "", to = "";
  const tdy = today();

  if(preset === "week"){
    from = startOfWeekISO(tdy);
    to = endOfWeekISO(tdy);
  } else if(preset === "month"){
    from = startOfMonthISO(tdy);
    to = endOfMonthISO(tdy);
  } else if(preset === "custom"){
    from = (fromDate.value || "").trim();
    to = (toDate.value || "").trim();
  }

  if(from && to && from > to){
    const tmp = from; from = to; to = tmp;
  }
  return { preset, from, to };
}

function filterDataByRange(data, f){
  if(!f || f.preset === "all") return data;
  if(!f.from && !f.to) return data;

  return data.filter(t => {
    const dt = String(t.date || "");
    if(!dt) return false;
    if(f.from && dt < f.from) return false;
    if(f.to && dt > f.to) return false;
    return true;
  });
}

function filterLabel(f){
  if(!f || f.preset === "all") return t("allTxns");
  if(f.preset === "week") return `${t("weekLabel")} (${f.from} ‚Üí ${f.to})`;
  if(f.preset === "month") return `${t("monthLabel")} (${f.from} ‚Üí ${f.to})`;
  if(f.preset === "custom"){
    if(f.from && f.to) return `${t("customLabel")} (${f.from} ‚Üí ${f.to})`;
    if(f.from && !f.to) return `${t("customLabel")} (${t("customFrom")} ${f.from})`;
    if(!f.from && f.to) return `${t("customLabel")} (${t("customTo")} ${f.to})`;
    return `${t("customLabel")} (select date)`;
  }
  return t("allTxns");
}

/* ===== aggregation ===== */
function sumByCategory(txns, type){
  const map = new Map();
  txns
    .filter(t => t.type === type)
    .forEach(t => {
      const cat = String(t.category || "Misc");
      const amt = Number(t.amount || 0);
      if(!amt || amt <= 0) return;
      map.set(cat, (map.get(cat) || 0) + amt);
    });

  return [...map.entries()]
    .map(([category, amount]) => ({ category, amount }))
    .sort((a,b) => b.amount - a.amount);
}

function totalFor(list){
  return list.reduce((s, x) => s + Number(x.amount || 0), 0);
}

/* ===== survival pill ===== */
function setSurvivalPill(net, burnPerDay){
  const el = document.getElementById("survivalPill");

  // if no activity at all
  if(net === 0 && burnPerDay === 0){
    el.className = "pill neutral";
    el.textContent = t("survNeutral");
    return;
  }

  // if net positive => healthy
  if(net > 0){
    el.className = "pill ok";
    el.textContent = t("survHealthy");
    return;
  }

  // net negative: grade by burn/day
  if(burnPerDay <= 20){
    el.className = "pill warn";
    el.textContent = t("survOk");
  } else if(burnPerDay <= 80){
    el.className = "pill warn";
    el.textContent = t("survWarning");
  } else {
    el.className = "pill bad";
    el.textContent = t("survCritical");
  }
}

/* ===== render ===== */
function render(){
  const all = loadLedger()
    .slice()
    .sort((a,b) => String(a.date).localeCompare(String(b.date)) || (a.id - b.id));

  // Apply month quick filter first (if set), then range filter
  const mf = getMonthFilter();
  let monthFiltered = all;

  if(mf.month){
    const from = mf.month + "-01";
    const to = endOfMonthISO(from);
    monthFiltered = all.filter(t => {
      const dt = String(t.date || "");
      return dt && dt >= from && dt <= to;
    });
  }

  const rf = getRangeFilter();
  const shown = filterDataByRange(monthFiltered, rf);

  const inList = sumByCategory(shown, "income");
  const outList = sumByCategory(shown, "expense");

  const inTotal = totalFor(inList);
  const outTotal = totalFor(outList);
  const net = inTotal - outTotal;

  // compute burn/day based on period boundaries
  let periodDays = 1;
  let periodLabelText = "";

  if(mf.month){
    const from = mf.month + "-01";
    const to = endOfMonthISO(from);
    periodDays = daysBetweenISO(from, to);
    periodLabelText = `${t("monthQuick")} (${from} ‚Üí ${to})`;
  } else if(rf && rf.preset !== "all" && (rf.from || rf.to)){
    const fFrom = rf.from || (shown[0] ? shown[0].date : today());
    const fTo = rf.to || (shown[shown.length-1] ? shown[shown.length-1].date : today());
    if(fFrom && fTo) periodDays = daysBetweenISO(fFrom, fTo);
    periodLabelText = filterLabel(rf);
  } else {
    // default: infer from shown date range if possible
    if(shown.length){
      const fFrom = shown[0].date;
      const fTo = shown[shown.length-1].date;
      if(fFrom && fTo) periodDays = daysBetweenISO(fFrom, fTo);
    }
    periodLabelText = t("allTxns");
  }

  const burn = (outTotal > 0) ? (outTotal / periodDays) : 0;

  // Summary
  sumIn.textContent = money(inTotal);
  sumOut.textContent = money(outTotal);
  sumNet.textContent = money(net);
  burnPerDay.textContent = money(burn);
  setSurvivalPill(net, burn);

  // Tables
  inRows.innerHTML = inList.length
    ? inList.map(x => `
      <tr>
        <td>${escapeHtml(x.category)}</td>
        <td class="right incomeTxt">${money(x.amount)}</td>
      </tr>
    `).join("")
    : `<tr><td colspan="2" class="muted" style="padding:12px;">-</td></tr>`;

  outRows.innerHTML = outList.length
    ? outList.map(x => `
      <tr>
        <td>${escapeHtml(x.category)}</td>
        <td class="right expenseTxt">${money(x.amount)}</td>
      </tr>
    `).join("")
    : `<tr><td colspan="2" class="muted" style="padding:12px;">-</td></tr>`;

  inTotalFoot.textContent = money(inTotal);
  outTotalFoot.textContent = money(outTotal);

  // hints
  const monthHint = mf.month ? `${t("monthQuick")}: ${mf.month}` : t("allTxns");
  monthHintTxt.textContent = t("showPrefix") + monthHint;

  filterHint.textContent = t("showPrefix") + filterLabel(rf);

  // print meta
  document.getElementById("phBiz").textContent = t("bizLabel") + "NiagaSenang (Local)";
  document.getElementById("phPeriod").textContent = t("periodLabel") + periodLabelText;
  document.getElementById("phPrinted").textContent = t("printedLabel") + nowReadable();
}

/* ===== month filter handlers ===== */
function syncMonthUI(){
  const mf = getMonthFilter();
  monthPick.value = mf.month || "";
}

function applyMonth(){
  const m = (monthPick.value || "").trim(); // YYYY-MM
  setMonthFilter({ month: m });
  try { gtag('event', 'filter_cashflow_month', { event_category:'accounting', event_label: m || 'none' }); } catch(e){}
  render();
}

function resetMonth(){
  setMonthFilter({ month:"" });
  syncMonthUI();
  render();
}

/* ===== range filter UI ===== */
function syncRangeUIFromState(){
  const f = getRangeFilter();
  rangePreset.value = f.preset || "all";

  if(f.preset === "custom"){
    fromDate.disabled = false;
    toDate.disabled = false;
    fromDate.value = f.from || "";
    toDate.value = f.to || "";
  } else {
    fromDate.disabled = true;
    toDate.disabled = true;

    if(f.preset === "week" || f.preset === "month"){
      fromDate.value = f.from || "";
      toDate.value = f.to || "";
    } else {
      fromDate.value = "";
      toDate.value = "";
    }
  }
}

rangePreset.addEventListener("change", () => {
  const preset = rangePreset.value;

  if(preset === "custom"){
    fromDate.disabled = false;
    toDate.disabled = false;
    if(!fromDate.value && !toDate.value){
      const tdy = today();
      fromDate.value = startOfMonthISO(tdy);
      toDate.value = endOfMonthISO(tdy);
    }
  } else {
    fromDate.disabled = true;
    toDate.disabled = true;
    const f = normalizeFilterFromUI();
    fromDate.value = f.from || "";
    toDate.value = f.to || "";
  }
});

function applyFilter(){
  const f = normalizeFilterFromUI();
  if(f.preset === "custom"){
    if(!f.from && !f.to){
      return alert(t("alertCustomNeedDate"));
    }
  }
  setRangeFilter(f);
  try { gtag('event', 'filter_cashflow', { event_category:'accounting', event_label: f.preset }); } catch(e){}
  render();
}

function resetFilter(){
  setRangeFilter({ preset:"all", from:"", to:"" });
  syncRangeUIFromState();
  render();
}

/* ===== print ===== */
function printCF(){
  try { gtag('event', 'print_cashflow', { event_category:'accounting' }); } catch(e){}
  render();
  window.print();
}

/* ===== init ===== */
(function init(){
  // init month UI
  syncMonthUI();

  // init range filter defaults
  const f = getRangeFilter();
  if((f.preset === "week" || f.preset === "month") && (!f.from || !f.to)){
    const tdy = today();
    if(f.preset === "week"){
      f.from = startOfWeekISO(tdy);
      f.to = endOfWeekISO(tdy);
    } else {
      f.from = startOfMonthISO(tdy);
      f.to = endOfMonthISO(tdy);
    }
    setRangeFilter(f);
  }
  syncRangeUIFromState();

  render();
})();
</script>

</body>
</html>