<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="UTF-8">
  <title>Ledger (Cash Basis) | NiagaSenang</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Ledger cash basis percuma untuk peniaga Malaysia. Rekod duit masuk & keluar, auto kira untung rugi.">

  <link rel="stylesheet" href="css/style.css">

  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-P81GM8SJWX"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-P81GM8SJWX');
  </script>

  <style>
    .grid-2 { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    .grid-3 { display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px; }
    table { width:100%; border-collapse:collapse; margin-top:12px; }
    th, td { padding:8px; border-bottom:1px solid #e5e7eb; font-size:14px; vertical-align:top; }
    th { text-align:left; background:#f8fafc; }
    .right { text-align:right; }
    .small { font-size:12px; color:#64748b; }

    .box {
      background:#f8fafc;
      border:1px solid #e5e7eb;
      border-radius:12px;
      padding:12px;
      margin-top:14px;
    }

    .pill{
      display:inline-block;
      padding:4px 8px;
      border-radius:999px;
      font-size:12px;
      border:1px solid #e5e7eb;
      background:#f8fafc;
      line-height:1.2;
      text-transform:capitalize;
    }
    .pill.income{
      background: rgba(4,120,87,.10);
      border-color: rgba(4,120,87,.25);
      color:#047857;
      font-weight:700;
    }
    .pill.expense{
      background: rgba(185,28,28,.10);
      border-color: rgba(185,28,28,.25);
      color:#b91c1c;
      font-weight:700;
    }

    .incomeTxt { color:#047857; font-weight:700; }
    .expenseTxt { color:#b91c1c; font-weight:700; }

    /* ===== Top header row (title + language toggle) ===== */
    .top-row{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .lang-toggle{
      display:flex;
      gap:6px;
      padding:4px;
      border:1px solid #e5e7eb;
      border-radius:999px;
      background:#ffffff;
      flex:0 0 auto;
      margin-top:2px;
    }
    .lang-btn{
      border:0;
      background:transparent;
      padding:6px 10px;
      border-radius:999px;
      font-weight:700;
      font-size:12px;
      cursor:pointer;
      color:#334155;
      line-height:1;
    }
    .lang-btn.active{
      background:#1e293b;
      color:#ffffff;
    }

    /* ===== Print layout ===== */
    .print-header{
      display:none;
      margin-bottom:12px;
      padding-bottom:10px;
      border-bottom:1px solid #e5e7eb;
    }
    .print-header h1{
      margin:0;
      font-size:18px;
      letter-spacing:.2px;
    }
    .print-meta{
      margin-top:6px;
      font-size:12px;
      color:#334155;
      display:flex;
      flex-wrap:wrap;
      gap:14px;
    }
    .print-meta span{
      display:inline-block;
      padding:4px 8px;
      border:1px solid #e5e7eb;
      border-radius:999px;
      background:#f8fafc;
    }

    /* Filter UI */
    .filter-row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:end;
      margin-top:10px;
    }
    .filter-row > div{ min-width: 160px; }
    .hint { font-size:12px; color:#64748b; margin-top:6px; }

    @media print {
      /* hide UI elements */
      .btn, .btn-secondary, button, input, select, textarea, a[href="index.html"], #importFile, .lang-toggle { display:none !important; }
      hr { border:0; border-top:1px solid #e5e7eb; }

      /* remove card shadow / background */
      body { background:#fff !important; }
      .card { box-shadow:none !important; border:0 !important; }

      /* show print header */
      .print-header { display:block !important; }

      /* tighten spacing */
      h2, h3, p { margin: 8px 0; }
      table { margin-top:10px; }
      th, td { font-size:12px; padding:6px; }

      /* keep table header on each page */
      thead { display: table-header-group; }
      tfoot { display: table-footer-group; }

      tr { page-break-inside: avoid; }

      .container { max-width: 100% !important; }
    }
  </style>
</head>

<body>
<div class="container">
<div class="card">

  <!-- PRINT ONLY HEADER -->
  <div class="print-header">
    <h1 id="phTitle">NiagaSenang ‚Äî Ledger (Cash Basis)</h1>
    <div class="print-meta">
      <span id="phBiz">Bisnes: -</span>
      <span id="phPeriod">Tempoh: Semua</span>
      <span id="phPrinted">Dicetak: -</span>
    </div>
  </div>

  <!-- Top row: title + lang toggle -->
  <div class="top-row">
    <div>
      <h2 data-i18n="pageH2">üìí Ledger (Cash Basis)</h2>
      <p class="small" data-i18n="pageIntro">
        Rekod duit masuk & keluar berdasarkan <strong>cash basis</strong>.
        Data disimpan dalam browser sahaja.
      </p>
    </div>

    <div class="lang-toggle" aria-label="Language toggle">
      <button type="button" class="lang-btn" data-lang="ms">BM</button>
      <button type="button" class="lang-btn" data-lang="en">EN</button>
    </div>
  </div>

  <hr style="margin:14px 0;">

  <!-- ADD TRANSACTION -->
  <h3 data-i18n="addTitle">‚ûï Rekod Transaksi</h3>

  <div class="grid-2">
    <div>
      <label data-i18n="labelType">Jenis</label>
      <select id="type">
        <option value="income" id="optIncome">Duit Masuk</option>
        <option value="expense" id="optExpense">Duit Keluar</option>
      </select>
    </div>

    <div>
      <label data-i18n="labelDate">Tarikh</label>
      <input type="date" id="date">
    </div>
  </div>

  <div class="grid-2">
    <div>
      <label data-i18n="labelCategory">Kategori</label>
      <select id="category">
        <option>Sales</option>
        <option>Service</option>
        <option>Stock</option>
        <option>Rent</option>
        <option>Marketing</option>
        <option>Utilities</option>
        <option>Transport</option>
        <option>Misc</option>
      </select>
    </div>

    <div>
      <label data-i18n="labelAmount">Jumlah (RM)</label>
      <input type="number" id="amount" step="0.01" placeholder="0.00">
    </div>
  </div>

  <div class="grid-2">
    <div>
      <label data-i18n="labelPayment">Cara Bayar</label>
      <select id="payment">
        <option id="payCash">Cash</option>
        <option id="payBank">Bank</option>
        <option id="payEwallet">E-Wallet</option>
      </select>
    </div>

    <div>
      <label data-i18n="labelNote">Nota (optional)</label>
      <input id="note" placeholder="Contoh: Invoice INV-0012">
    </div>
  </div>

  <div style="margin-top:12px;">
    <button class="btn" onclick="addTxn()" data-i18n="btnSave">Simpan Transaksi</button>
  </div>

  <!-- FILTER -->
  <div class="box">
    <h3 data-i18n="filterTitle">üóìÔ∏è Filter Tarikh (paparan & print)</h3>

    <div class="filter-row">
      <div>
        <label data-i18n="labelRange">Range</label>
        <select id="rangePreset">
          <option value="all" id="rngAll">Semua</option>
          <option value="week" id="rngWeek">Minggu Ini</option>
          <option value="month" id="rngMonth">Bulan Ini</option>
          <option value="custom" id="rngCustom">Custom</option>
        </select>
      </div>

      <div>
        <label data-i18n="labelFrom">Dari</label>
        <input type="date" id="fromDate" disabled>
      </div>

      <div>
        <label data-i18n="labelTo">Hingga</label>
        <input type="date" id="toDate" disabled>
      </div>

      <div>
        <button class="btn-secondary" onclick="applyFilter()" data-i18n="btnApply">Apply</button>
        <button class="btn-secondary" onclick="resetFilter()" data-i18n="btnReset">Reset</button>
      </div>
    </div>

    <div class="hint" id="filterHint">Menunjukkan: Semua transaksi</div>
  </div>

  <!-- SUMMARY -->
  <div class="box">
    <h3 data-i18n="summaryTitle">üìä Ringkasan (ikut filter)</h3>
    <div class="grid-3">
      <div>
        <div class="small" data-i18n="sumIncomeLabel">Jumlah Income</div>
        <strong class="incomeTxt">RM <span id="sumIncome">0.00</span></strong>
      </div>
      <div>
        <div class="small" data-i18n="sumExpenseLabel">Jumlah Expense</div>
        <strong class="expenseTxt">RM <span id="sumExpense">0.00</span></strong>
      </div>
      <div>
        <div class="small" data-i18n="sumProfitLabel">Untung / Rugi</div>
        <strong>RM <span id="sumProfit">0.00</span></strong>
      </div>
    </div>
  </div>

  <!-- TABLE -->
  <h3 style="margin-top:18px;" data-i18n="tableTitle">üìÑ Senarai Transaksi (ikut filter)</h3>

  <table>
    <thead>
      <tr>
        <th data-i18n="thDate">Tarikh</th>
        <th data-i18n="thType">Jenis</th>
        <th data-i18n="thCategory">Kategori</th>
        <th data-i18n="thPayment">Cara Bayar</th>
        <th data-i18n="thNote">Nota</th>
        <th class="right" data-i18n="thAmount">Jumlah (RM)</th>
        <th data-i18n="thAction"></th>
      </tr>
    </thead>
    <tbody id="list"></tbody>
  </table>

  <!-- BACKUP -->
  <div style="margin-top:14px;">
    <button class="btn-secondary" onclick="exportData()" data-i18n="btnExport">‚¨á Export Backup</button>
    <input type="file" id="importFile" accept="application/json" style="display:none">
    <button class="btn-secondary" onclick="document.getElementById('importFile').click()" data-i18n="btnImport">‚¨Ü Import Backup</button>
    <button class="btn-secondary" onclick="printLedger()" data-i18n="btnPrint">üñ® Print Ledger (ikut filter)</button>
  </div>

  <p class="small" style="margin-top:16px;" data-i18n="disclaimerText">
    Tool ini adalah <strong>cash basis accounting</strong> untuk kegunaan dalaman.
    Belum termasuk e-Invoice LHDN.
  </p>

  <p style="margin-top:16px;">
    <a href="index.html" data-i18n="backLink">‚Üê Kembali ke NiagaSenang</a>
  </p>

</div>
</div>

<script>
/* =======================
   Storage Keys
======================= */
const KEY = "ns_ledger_v3";
const FILTER_KEY = "ns_ledger_filter_v1";
const LANG_KEY = "ns_lang"; // shared with landing

let CURRENT_LANG = "ms";

/* =======================
   i18n dictionary
======================= */
const I18N = {
  ms: {
    docTitle: "Ledger (Cash Basis) | NiagaSenang",

    pageH2: "üìí Ledger (Cash Basis)",
    pageIntro: "Rekod duit masuk & keluar berdasarkan <strong>cash basis</strong>. Data disimpan dalam browser sahaja.",

    addTitle: "‚ûï Rekod Transaksi",
    labelType: "Jenis",
    labelDate: "Tarikh",
    labelCategory: "Kategori",
    labelAmount: "Jumlah (RM)",
    labelPayment: "Cara Bayar",
    labelNote: "Nota (optional)",
    notePlaceholder: "Contoh: Invoice INV-0012",
    btnSave: "Simpan Transaksi",

    optIncome: "Duit Masuk",
    optExpense: "Duit Keluar",

    filterTitle: "üóìÔ∏è Filter Tarikh (paparan & print)",
    labelRange: "Range",
    labelFrom: "Dari",
    labelTo: "Hingga",
    btnApply: "Apply",
    btnReset: "Reset",
    rngAll: "Semua",
    rngWeek: "Minggu Ini",
    rngMonth: "Bulan Ini",
    rngCustom: "Custom",

    summaryTitle: "üìä Ringkasan (ikut filter)",
    sumIncomeLabel: "Jumlah Income",
    sumExpenseLabel: "Jumlah Expense",
    sumProfitLabel: "Untung / Rugi",

    tableTitle: "üìÑ Senarai Transaksi (ikut filter)",
    thDate: "Tarikh",
    thType: "Jenis",
    thCategory: "Kategori",
    thPayment: "Cara Bayar",
    thNote: "Nota",
    thAmount: "Jumlah (RM)",

    btnExport: "‚¨á Export Backup",
    btnImport: "‚¨Ü Import Backup",
    btnPrint: "üñ® Print Ledger (ikut filter)",

    disclaimerText: "Tool ini adalah <strong>cash basis accounting</strong> untuk kegunaan dalaman. Belum termasuk e-Invoice LHDN.",
    backLink: "‚Üê Kembali ke NiagaSenang",

    // dynamic strings
    showPrefix: "Menunjukkan: ",
    allTxns: "Semua transaksi",
    weekLabel: "Minggu ini",
    monthLabel: "Bulan ini",
    customLabel: "Custom",
    customFrom: "dari",
    customTo: "hingga",

    bizLabel: "Bisnes: ",
    periodLabel: "Tempoh: ",
    printedLabel: "Dicetak: ",

    alertAmount: "Masukkan jumlah (lebih dari 0)",
    alertDate: "Sila pilih tarikh",
    alertCustomNeedDate: "Untuk Custom, sila pilih tarikh Dari / Hingga (sekurang-kurangnya satu).",
    alertImportOk: "‚úÖ Backup berjaya diimport!",
    alertImportFail: "‚ùå Import gagal. Pastikan fail backup niagasenang-ledger-backup.json yang betul.",

    removeBtn: "‚ùå",

    typePillIncome: "income",
    typePillExpense: "expense",
    typeTextIncome: "Duit Masuk",
    typeTextExpense: "Duit Keluar",

    phTitle: "NiagaSenang ‚Äî Ledger (Cash Basis)"
  },

  en: {
    docTitle: "Ledger (Cash Basis) | NiagaSenang",

    pageH2: "üìí Ledger (Cash Basis)",
    pageIntro: "Track money in & out using <strong>cash basis</strong>. Data is stored locally in your browser.",

    addTitle: "‚ûï Add Transaction",
    labelType: "Type",
    labelDate: "Date",
    labelCategory: "Category",
    labelAmount: "Amount (RM)",
    labelPayment: "Payment Method",
    labelNote: "Note (optional)",
    notePlaceholder: "Example: Invoice INV-0012",
    btnSave: "Save Transaction",

    optIncome: "Money In",
    optExpense: "Money Out",

    filterTitle: "üóìÔ∏è Date Filter (view & print)",
    labelRange: "Range",
    labelFrom: "From",
    labelTo: "To",
    btnApply: "Apply",
    btnReset: "Reset",
    rngAll: "All",
    rngWeek: "This Week",
    rngMonth: "This Month",
    rngCustom: "Custom",

    summaryTitle: "üìä Summary (filtered)",
    sumIncomeLabel: "Total Income",
    sumExpenseLabel: "Total Expense",
    sumProfitLabel: "Profit / Loss",

    tableTitle: "üìÑ Transactions (filtered)",
    thDate: "Date",
    thType: "Type",
    thCategory: "Category",
    thPayment: "Payment",
    thNote: "Note",
    thAmount: "Amount (RM)",

    btnExport: "‚¨á Export Backup",
    btnImport: "‚¨Ü Import Backup",
    btnPrint: "üñ® Print Ledger (filtered)",

    disclaimerText: "This is a <strong>cash basis</strong> internal ledger tool. It does not include official LHDN e-Invoice submission.",
    backLink: "‚Üê Back to NiagaSenang",

    // dynamic strings
    showPrefix: "Showing: ",
    allTxns: "All transactions",
    weekLabel: "This week",
    monthLabel: "This month",
    customLabel: "Custom",
    customFrom: "from",
    customTo: "to",

    bizLabel: "Business: ",
    periodLabel: "Period: ",
    printedLabel: "Printed: ",

    alertAmount: "Enter an amount (greater than 0)",
    alertDate: "Please choose a date",
    alertCustomNeedDate: "For Custom, choose From/To dates (at least one).",
    alertImportOk: "‚úÖ Backup imported successfully!",
    alertImportFail: "‚ùå Import failed. Please upload a valid niagasenang-ledger-backup.json file.",

    removeBtn: "‚ùå",

    typePillIncome: "income",
    typePillExpense: "expense",
    typeTextIncome: "Money In",
    typeTextExpense: "Money Out",

    phTitle: "NiagaSenang ‚Äî Ledger (Cash Basis)"
  }
};

/* =======================
   Helpers
======================= */
function today() { return new Date().toISOString().slice(0,10); }

function nowReadable(){
  const d = new Date();
  const locale = (CURRENT_LANG === "en") ? "en-US" : "ms-MY";
  return d.toLocaleString(locale, { year:'numeric', month:'short', day:'2-digit', hour:'2-digit', minute:'2-digit' });
}

function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function money(n) { return Number(n || 0).toFixed(2); }

function t(key){
  const pack = I18N[CURRENT_LANG] || I18N.ms;
  return (pack[key] != null) ? pack[key] : (I18N.ms[key] ?? "");
}

/* =======================
   Language
======================= */
function detectBrowserLang(){
  const nav = (navigator.language || "").toLowerCase();
  return nav.startsWith("en") ? "en" : "ms";
}

function applyLang(lang){
  CURRENT_LANG = (lang === "en") ? "en" : "ms";
  localStorage.setItem(LANG_KEY, CURRENT_LANG);

  // active state
  document.querySelectorAll(".lang-btn").forEach(btn => {
    btn.classList.toggle("active", btn.dataset.lang === CURRENT_LANG);
  });

  // html lang + title
  document.documentElement.setAttribute("lang", CURRENT_LANG === "en" ? "en" : "ms");
  document.title = t("docTitle");

  // static text via data-i18n
  document.querySelectorAll("[data-i18n]").forEach(el => {
    const key = el.getAttribute("data-i18n");
    const val = t(key);
    if (val != null && val !== "") el.innerHTML = val;
  });

  // specific placeholders/options
  const noteEl = document.getElementById("note");
  if(noteEl) noteEl.placeholder = t("notePlaceholder");

  const optIncome = document.getElementById("optIncome");
  const optExpense = document.getElementById("optExpense");
  if(optIncome) optIncome.textContent = t("optIncome");
  if(optExpense) optExpense.textContent = t("optExpense");

  const rngAll = document.getElementById("rngAll");
  const rngWeek = document.getElementById("rngWeek");
  const rngMonth = document.getElementById("rngMonth");
  const rngCustom = document.getElementById("rngCustom");
  if(rngAll) rngAll.textContent = t("rngAll");
  if(rngWeek) rngWeek.textContent = t("rngWeek");
  if(rngMonth) rngMonth.textContent = t("rngMonth");
  if(rngCustom) rngCustom.textContent = t("rngCustom");

  // print header title
  const phTitle = document.getElementById("phTitle");
  if(phTitle) phTitle.textContent = t("phTitle");

  // re-render so dynamic text (filter hint, pills, print meta) follow language
  render();
}

// init lang: saved > browser
(function initLang(){
  const saved = localStorage.getItem(LANG_KEY);
  const start = saved || detectBrowserLang();
  applyLang(start);

  document.querySelectorAll(".lang-btn").forEach(btn => {
    btn.addEventListener("click", () => applyLang(btn.dataset.lang));
  });
})();

/* =======================
   Storage
======================= */
function load() {
  try {
    const v = JSON.parse(localStorage.getItem(KEY) || "[]");
    return Array.isArray(v) ? v : [];
  } catch(e){ return []; }
}

function save(data) { localStorage.setItem(KEY, JSON.stringify(data)); }

/* =======================
   Filter state
======================= */
function getFilter(){
  try{
    const f = JSON.parse(localStorage.getItem(FILTER_KEY) || "{}");
    return {
      preset: f.preset || "all",
      from: f.from || "",
      to: f.to || ""
    };
  }catch(e){
    return { preset:"all", from:"", to:"" };
  }
}
function setFilter(f){ localStorage.setItem(FILTER_KEY, JSON.stringify(f)); }

function startOfWeekISO(d){
  // Monday as start (ms-MY common)
  const date = new Date(d);
  const day = date.getDay(); // 0 Sun ... 6 Sat
  const diff = (day === 0 ? -6 : 1 - day);
  date.setDate(date.getDate() + diff);
  return date.toISOString().slice(0,10);
}

function endOfWeekISO(d){
  const start = new Date(startOfWeekISO(d));
  start.setDate(start.getDate() + 6);
  return start.toISOString().slice(0,10);
}

function startOfMonthISO(d){
  const date = new Date(d);
  date.setDate(1);
  return date.toISOString().slice(0,10);
}

function endOfMonthISO(d){
  const date = new Date(d);
  date.setMonth(date.getMonth() + 1);
  date.setDate(0);
  return date.toISOString().slice(0,10);
}

function normalizeFilterFromUI(){
  const preset = rangePreset.value;
  let from = "";
  let to = "";
  const tt = today();

  if(preset === "week"){
    from = startOfWeekISO(tt);
    to = endOfWeekISO(tt);
  } else if(preset === "month"){
    from = startOfMonthISO(tt);
    to = endOfMonthISO(tt);
  } else if(preset === "custom"){
    from = (fromDate.value || "").trim();
    to = (toDate.value || "").trim();
  }

  // swap if user terbalik
  if(from && to && from > to){
    const tmp = from; from = to; to = tmp;
  }

  return { preset, from, to };
}

function filterData(data, f){
  if(!f || f.preset === "all") return data;
  if(!f.from && !f.to) return data;

  return data.filter(tnx => {
    const dt = String(tnx.date || "");
    if(!dt) return false;
    if(f.from && dt < f.from) return false;
    if(f.to && dt > f.to) return false;
    return true;
  });
}

function filterLabel(f){
  if(!f || f.preset === "all") return t("allTxns");
  if(f.preset === "week") return `${t("weekLabel")} (${f.from} ‚Üí ${f.to})`;
  if(f.preset === "month") return `${t("monthLabel")} (${f.from} ‚Üí ${f.to})`;
  if(f.preset === "custom"){
    if(f.from && f.to) return `${t("customLabel")} (${f.from} ‚Üí ${f.to})`;
    if(f.from && !f.to) return `${t("customLabel")} (${t("customFrom")} ${f.from})`;
    if(!f.from && f.to) return `${t("customLabel")} (${t("customTo")} ${f.to})`;
    return `${t("customLabel")} (select date)`;
  }
  return t("allTxns");
}

/* =======================
   Ledger Ops
======================= */
function addTxn() {
  const data = load();

  const txn = {
    id: Date.now(),
    type: type.value,
    date: date.value || today(),
    category: category.value,
    amount: Number(amount.value || 0),
    payment: payment.value,
    note: (note.value || "").trim()
  };

  if (!txn.amount || txn.amount <= 0) return alert(t("alertAmount"));
  if (!txn.date) return alert(t("alertDate"));

  data.push(txn);
  save(data);

  amount.value = "";
  note.value = "";

  try { gtag('event', 'add_ledger', { event_category:'accounting' }); } catch(e){}

  render();
}

function removeTxn(id) {
  const data = load().filter(tt => tt.id !== id);
  save(data);
  render();
}

function calcSummary(data){
  let income = 0, expense = 0;
  data.forEach(tt => {
    if (tt.type === "income") income += Number(tt.amount || 0);
    else expense += Number(tt.amount || 0);
  });
  return { income, expense, profit: income - expense };
}

function render() {
  const all = load()
    .slice()
    .sort((a,b) => String(a.date).localeCompare(String(b.date)) || (a.id - b.id));

  const f = getFilter();
  const shown = filterData(all, f);

  // table
  list.innerHTML = "";
  shown.forEach(tt => {
    const typeLabel = (tt.type === "income") ? t("typePillIncome") : t("typePillExpense");
    const amountClass = (tt.type === "income") ? "incomeTxt" : "expenseTxt";
    const typeText = (tt.type === "income") ? t("typeTextIncome") : t("typeTextExpense");

    list.innerHTML += `
      <tr>
        <td>${escapeHtml(tt.date || "-")}</td>
        <td><span class="pill ${typeLabel}">${escapeHtml(typeText)}</span></td>
        <td>${escapeHtml(tt.category || "-")}</td>
        <td>${escapeHtml(tt.payment || "-")}</td>
        <td>${escapeHtml(tt.note || "-")}</td>
        <td class="right ${amountClass}">${money(tt.amount)}</td>
        <td><button onclick="removeTxn(${tt.id})">${t("removeBtn")}</button></td>
      </tr>`;
  });

  // summary (ikut filter)
  const {income, expense, profit} = calcSummary(shown);
  sumIncome.textContent = money(income);
  sumExpense.textContent = money(expense);
  sumProfit.textContent = money(profit);

  // filter hint + print header meta
  const label = filterLabel(f);
  filterHint.textContent = t("showPrefix") + label;

  document.getElementById("phBiz").textContent = t("bizLabel") + "NiagaSenang (Local)";
  document.getElementById("phPeriod").textContent = t("periodLabel") + label;
  document.getElementById("phPrinted").textContent = t("printedLabel") + nowReadable();
}

/* =======================
   Filter UI handlers
======================= */
function syncFilterUIFromState(){
  const f = getFilter();
  rangePreset.value = f.preset || "all";

  if(f.preset === "custom"){
    fromDate.disabled = false;
    toDate.disabled = false;
    fromDate.value = f.from || "";
    toDate.value = f.to || "";
  } else {
    fromDate.disabled = true;
    toDate.disabled = true;

    // set computed dates for week/month so user nampak bila tukar ke custom nanti
    if(f.preset === "week" || f.preset === "month"){
      fromDate.value = f.from || "";
      toDate.value = f.to || "";
    } else {
      fromDate.value = "";
      toDate.value = "";
    }
  }
}

rangePreset.addEventListener("change", () => {
  const preset = rangePreset.value;

  if(preset === "custom"){
    fromDate.disabled = false;
    toDate.disabled = false;
    // if empty, default letak bulan ini
    if(!fromDate.value && !toDate.value){
      const tt = today();
      fromDate.value = startOfMonthISO(tt);
      toDate.value = endOfMonthISO(tt);
    }
  } else {
    fromDate.disabled = true;
    toDate.disabled = true;
    // auto-fill preview
    const f = normalizeFilterFromUI();
    fromDate.value = f.from || "";
    toDate.value = f.to || "";
  }
});

function applyFilter(){
  const f = normalizeFilterFromUI();

  // validation for custom
  if(f.preset === "custom"){
    if(!f.from && !f.to){
      return alert(t("alertCustomNeedDate"));
    }
  }

  setFilter(f);
  try { gtag('event', 'filter_ledger', { event_category:'accounting', event_label: f.preset }); } catch(e){}
  render();
}

function resetFilter(){
  setFilter({ preset:"all", from:"", to:"" });
  syncFilterUIFromState();
  render();
}

/* =======================
   Backup
======================= */
function exportData() {
  const payload = {
    app: "NiagaSenang Ledger (Cash Basis)",
    version: 3,
    exportedAt: new Date().toISOString(),
    data: load()
  };
  const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "niagasenang-ledger-backup.json";
  a.click();
  URL.revokeObjectURL(a.href);

  try { gtag('event', 'export_ledger', { event_category:'accounting' }); } catch(e){}
}

document.getElementById("importFile").addEventListener("change", e => {
  const file = e.target.files[0];
  if (!file) return;

  const r = new FileReader();
  r.onload = () => {
    try{
      const raw = JSON.parse(r.result);
      const arr = Array.isArray(raw) ? raw : (Array.isArray(raw.data) ? raw.data : null);
      if (!arr) throw new Error("bad format");

      const cleaned = arr.map(x => ({
        id: Number(x.id || Date.now()),
        type: (x.type === "income" || x.type === "expense") ? x.type : "income",
        date: String(x.date || today()).slice(0,10),
        category: String(x.category || "Misc"),
        amount: Number(x.amount || 0),
        payment: String(x.payment || "Cash"),
        note: String(x.note || "")
      })).filter(x => x.amount > 0);

      save(cleaned);
      alert(t("alertImportOk"));
      try { gtag('event', 'import_ledger', { event_category:'accounting' }); } catch(e){}

      render();
    }catch(err){
      alert(t("alertImportFail"));
    } finally {
      e.target.value = "";
    }
  };
  r.readAsText(file);
});

/* =======================
   Print
======================= */
function printLedger() {
  try { gtag('event', 'print_ledger', { event_category:'accounting' }); } catch(e){}
  render(); // refresh meta before printing
  window.print();
}

/* =======================
   Init
======================= */
date.value = today();

// init filter defaults (kalau belum set)
(function initFilter(){
  const f = getFilter();
  // if week/month but missing dates, fill
  if((f.preset === "week" || f.preset === "month") && (!f.from || !f.to)){
    const tt = today();
    if(f.preset === "week"){
      f.from = startOfWeekISO(tt);
      f.to = endOfWeekISO(tt);
    } else {
      f.from = startOfMonthISO(tt);
      f.to = endOfMonthISO(tt);
    }
    setFilter(f);
  }
  syncFilterUIFromState();
})();

render();
</script>

</body>
</html>