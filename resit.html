<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Resit Percuma Pro Malaysia | NiagaSenang</title>
  <meta name="description" content="Resit percuma pro untuk peniaga Malaysia. Multi-item, diskaun, SST 6%, auto numbering dan terus download PDF tanpa login.">
  <link rel="stylesheet" href="css/style.css">

  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-P81GM8SJWX"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-P81GM8SJWX');
  </script>

  <style>
    table { width:100%; border-collapse:collapse; margin-top:8px; }
    th, td { border-bottom:1px solid #e5e7eb; padding:8px 6px; vertical-align:top; }
    th { font-size:13px; text-align:left; }
    .grid-2 { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    .grid-3 { display:grid; grid-template-columns:1.2fr 1fr 1fr; gap:12px; }
    .btn-secondary {
      background:rgba(15,118,110,.12);
      color:#0f766e;
      border:1px solid rgba(15,118,110,.25);
      padding:10px 14px;
      border-radius:8px;
      cursor:pointer;
      margin-right:8px;
    }
    .btn-secondary:hover { background:rgba(15,118,110,.18); }
    .totals-box {
      background:#f8fafc;
      border:1px solid #e5e7eb;
      border-radius:10px;
      padding:12px;
      margin-top:12px;
    }
    .totals-row { display:flex; justify-content:space-between; margin:6px 0; }
    .muted { color:#64748b; font-size:13px; }
    .small { font-size:12px; color:#64748b; }

    /* ===== Top row (title + language toggle) ===== */
    .top-row{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .lang-toggle{
      display:flex;
      gap:6px;
      padding:4px;
      border:1px solid #e5e7eb;
      border-radius:999px;
      background:#ffffff;
      flex:0 0 auto;
      margin-top:2px;
    }
    .lang-btn{
      border:0;
      background:transparent;
      padding:6px 10px;
      border-radius:999px;
      font-weight:700;
      font-size:12px;
      cursor:pointer;
      color:#334155;
      line-height:1;
    }
    .lang-btn.active{
      background:#1e293b;
      color:#ffffff;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="card">

      <div class="top-row">
        <div>
          <h2 data-i18n="h2">üßæ Resit Percuma (Pro)</h2>
          <p class="muted" data-i18n="subtitle">Multi-item, diskaun, SST 6% & auto numbering. Data auto simpan (draft).</p>
        </div>

        <!-- Language toggle -->
        <div class="lang-toggle" aria-label="Language toggle">
          <button type="button" class="lang-btn" data-lang="ms">BM</button>
          <button type="button" class="lang-btn" data-lang="en">EN</button>
        </div>
      </div>

      <label data-i18n="lblBiz">Nama Perniagaan</label>
      <input id="biz" placeholder="Contoh: Kedai Makan Pak Ali">

      <label data-i18n="lblBizAddr">Alamat Perniagaan (optional)</label>
      <input id="bizAddr" placeholder="Contoh: No 12, Jalan ABC, 43000 Kajang">

      <div class="grid-2">
        <div>
          <label data-i18n="lblDocNo">No Resit</label>
          <input id="docNo" readonly>
        </div>
        <div>
          <label data-i18n="lblDate">Tarikh</label>
          <input id="docDate" type="date">
        </div>
      </div>

      <label data-i18n="lblCust">Nama Pelanggan (optional)</label>
      <input id="cust" placeholder="Contoh: Ahmad">

      <label data-i18n="lblCustAddr">Alamat Pelanggan (optional)</label>
      <input id="custAddr" placeholder="Contoh: Shah Alam, Selangor">

      <div class="grid-2" style="margin-top:10px;">
        <div>
          <label data-i18n="lblPayMethod">Kaedah Bayaran (optional)</label>
          <input id="payMethod" placeholder="Contoh: Cash / Transfer / QR">
        </div>
        <div>
          <label data-i18n="lblPayRef">Rujukan Bayaran (optional)</label>
          <input id="payRef" placeholder="Contoh: TXN123 / Maybank2u">
        </div>
      </div>

      <hr style="margin:16px 0;">

      <h3 data-i18n="itemsTitle">Butiran Item</h3>
      <table id="itemsTable">
        <thead>
          <tr>
            <th style="width:52%;" data-i18n="thDesc">Butiran</th>
            <th style="width:12%;" data-i18n="thQty">Qty</th>
            <th style="width:20%;" data-i18n="thPrice">Harga (RM)</th>
            <th style="width:16%;"></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <button class="btn-secondary" onclick="addRow()" data-i18n="btnAddItem">‚ûï Tambah Item</button>
      <button class="btn-secondary" onclick="clearItems()" data-i18n="btnClear">üßπ Clear</button>

      <hr style="margin:16px 0;">

      <div class="grid-3">
        <div>
          <label data-i18n="lblDiscountType">Diskaun Type</label>
          <select id="discountType">
            <option value="rm">RM</option>
            <option value="percent">%</option>
          </select>
        </div>
        <div>
          <label data-i18n="lblDiscount">Diskaun</label>
          <input id="discountVal" type="number" step="0.01" value="0">
        </div>
        <div>
          <label data-i18n="lblSst">SST 6%</label>
          <div style="display:flex; gap:10px; align-items:center; margin-top:6px;">
            <input id="sstOn" type="checkbox">
            <span data-i18n="sstApply">Apply</span>
          </div>
        </div>
      </div>

      <div class="totals-box">
        <div class="totals-row"><span data-i18n="subTotal">Subtotal</span><span>RM <span id="subtotalTxt">0.00</span></span></div>
        <div class="totals-row"><span data-i18n="discountLabel">Diskaun</span><span>- RM <span id="discountAmtTxt">0.00</span></span></div>
        <div class="totals-row"><span data-i18n="sstLabel">SST (6%)</span><span>RM <span id="sstAmtTxt">0.00</span></span></div>
        <hr>
        <div class="totals-row"><strong data-i18n="totalPaid">TOTAL DIBAYAR</strong><strong>RM <span id="grandTotalTxt">0.00</span></strong></div>
      </div>

      <label data-i18n="lblNote">Nota (optional)</label>
      <input id="note" placeholder="Contoh: Terima kasih kerana membeli.">

      <div style="margin-top:14px;">
        <button class="btn" onclick="generatePDF()" data-i18n="btnDownload">Download PDF</button>
        <button class="btn-secondary" onclick="newDoc()" data-i18n="btnNew">üÜï Resit Baru</button>
      </div>

      <p class="small" style="margin-top:14px;">
        <span data-i18n="helpText">Ada cadangan / perlukan bantuan? Email</span>
        <a href="mailto:niagasenang@gmail.com">niagasenang@gmail.com</a>
      </p>

      <p style="margin-top:16px;">
        <a href="index.html" data-i18n="backLink">‚Üê Kembali ke NiagaSenang</a>
      </p>

    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    /* =======================
       Language (shared key)
    ======================= */
    const LANG_KEY = "ns_lang";
    let CURRENT_LANG = "ms";

    const I18N = {
      ms: {
        docTitle: "Resit Percuma Pro Malaysia | NiagaSenang",
        h2: "üßæ Resit Percuma (Pro)",
        subtitle: "Multi-item, diskaun, SST 6% & auto numbering. Data auto simpan (draft).",

        lblBiz: "Nama Perniagaan",
        phBiz: "Contoh: Kedai Makan Pak Ali",
        lblBizAddr: "Alamat Perniagaan (optional)",
        phBizAddr: "Contoh: No 12, Jalan ABC, 43000 Kajang",

        lblDocNo: "No Resit",
        lblDate: "Tarikh",

        lblCust: "Nama Pelanggan (optional)",
        phCust: "Contoh: Ahmad",
        lblCustAddr: "Alamat Pelanggan (optional)",
        phCustAddr: "Contoh: Shah Alam, Selangor",

        lblPayMethod: "Kaedah Bayaran (optional)",
        phPayMethod: "Contoh: Cash / Transfer / QR",
        lblPayRef: "Rujukan Bayaran (optional)",
        phPayRef: "Contoh: TXN123 / Maybank2u",

        itemsTitle: "Butiran Item",
        thDesc: "Butiran",
        thQty: "Qty",
        thPrice: "Harga (RM)",

        btnAddItem: "‚ûï Tambah Item",
        btnClear: "üßπ Clear",

        lblDiscountType: "Diskaun Type",
        lblDiscount: "Diskaun",
        lblSst: "SST 6%",
        sstApply: "Apply",

        subTotal: "Subtotal",
        discountLabel: "Diskaun",
        sstLabel: "SST (6%)",
        totalPaid: "TOTAL DIBAYAR",

        lblNote: "Nota (optional)",
        phNote: "Contoh: Terima kasih kerana membeli.",

        btnDownload: "Download PDF",
        btnNew: "üÜï Resit Baru",

        helpText: "Ada cadangan / perlukan bantuan? Email",
        backLink: "‚Üê Kembali ke NiagaSenang",

        phItemDesc: "Contoh: Nasi Ayam",

        // PDF labels
        pdfTitle: "RESIT",
        pdfDocNo: "No Resit:",
        pdfDate: "Tarikh:",
        pdfFrom: "Daripada",
        pdfTo: "Kepada",
        pdfPay: "Bayaran:",
        pdfMethod: "Kaedah",
        pdfRef: "Rujukan",
        pdfDesc: "Butiran",
        pdfQty: "Qty",
        pdfPrice: "Harga",
        pdfAmount: "Jumlah",
        pdfSubtotal: "Subtotal",
        pdfDiscount: "Diskaun",
        pdfSst: "SST (6%)",
        pdfTotalPaid: "TOTAL DIBAYAR",
        pdfNote: "Nota:",
        pdfFooter: "Generated by NiagaSenang",

        pdfBizFallback: "Nama Perniagaan"
      },

      en: {
        docTitle: "Pro Receipt Generator | NiagaSenang",
        h2: "üßæ Free Receipt (Pro)",
        subtitle: "Multi-item, discounts, optional tax & auto numbering. Auto-saves as draft.",

        lblBiz: "Business Name",
        phBiz: "Example: Pak Ali Restaurant",
        lblBizAddr: "Business Address (optional)",
        phBizAddr: "Example: No 12, Jalan ABC, 43000 Kajang",

        lblDocNo: "Receipt No",
        lblDate: "Date",

        lblCust: "Customer Name (optional)",
        phCust: "Example: Ahmad",
        lblCustAddr: "Customer Address (optional)",
        phCustAddr: "Example: Shah Alam, Selangor",

        lblPayMethod: "Payment Method (optional)",
        phPayMethod: "Example: Cash / Transfer / QR",
        lblPayRef: "Payment Reference (optional)",
        phPayRef: "Example: TXN123 / Bank ref",

        itemsTitle: "Item Details",
        thDesc: "Description",
        thQty: "Qty",
        thPrice: "Price (RM)",

        btnAddItem: "‚ûï Add Item",
        btnClear: "üßπ Clear",

        lblDiscountType: "Discount Type",
        lblDiscount: "Discount",
        lblSst: "Tax (6%)",
        sstApply: "Apply",

        subTotal: "Subtotal",
        discountLabel: "Discount",
        sstLabel: "Tax (6%)",
        totalPaid: "TOTAL PAID",

        lblNote: "Note (optional)",
        phNote: "Example: Thank you for your purchase.",

        btnDownload: "Download PDF",
        btnNew: "üÜï New Receipt",

        helpText: "Suggestions / need help? Email",
        backLink: "‚Üê Back to NiagaSenang",

        phItemDesc: "Example: Chicken Rice",

        pdfTitle: "RECEIPT",
        pdfDocNo: "Receipt No:",
        pdfDate: "Date:",
        pdfFrom: "From",
        pdfTo: "To",
        pdfPay: "Payment:",
        pdfMethod: "Method",
        pdfRef: "Reference",
        pdfDesc: "Description",
        pdfQty: "Qty",
        pdfPrice: "Price",
        pdfAmount: "Amount",
        pdfSubtotal: "Subtotal",
        pdfDiscount: "Discount",
        pdfSst: "Tax (6%)",
        pdfTotalPaid: "TOTAL PAID",
        pdfNote: "Note:",
        pdfFooter: "Generated by NiagaSenang",

        pdfBizFallback: "Business Name"
      }
    };

    function detectBrowserLang(){
      const nav = (navigator.language || "").toLowerCase();
      return nav.startsWith("en") ? "en" : "ms";
    }

    function t(key){
      const pack = I18N[CURRENT_LANG] || I18N.ms;
      return (pack[key] != null) ? pack[key] : (I18N.ms[key] ?? "");
    }

    function applyLang(lang){
      CURRENT_LANG = (lang === "en") ? "en" : "ms";
      localStorage.setItem(LANG_KEY, CURRENT_LANG);

      document.documentElement.setAttribute("lang", CURRENT_LANG === "en" ? "en" : "ms");
      document.title = t("docTitle");

      document.querySelectorAll(".lang-btn").forEach(btn => {
        btn.classList.toggle("active", btn.dataset.lang === CURRENT_LANG);
      });

      document.querySelectorAll("[data-i18n]").forEach(el => {
        const key = el.getAttribute("data-i18n");
        const val = t(key);
        if (val != null && val !== "") el.innerHTML = val;
      });

      // placeholders
      biz.placeholder = t("phBiz");
      bizAddr.placeholder = t("phBizAddr");
      cust.placeholder = t("phCust");
      custAddr.placeholder = t("phCustAddr");
      payMethod.placeholder = t("phPayMethod");
      payRef.placeholder = t("phPayRef");
      note.placeholder = t("phNote");

      // update existing item row placeholders
      document.querySelectorAll("#itemsTable tbody tr .desc").forEach(inp => {
        inp.placeholder = t("phItemDesc");
      });
    }

    // init language
    (function initLang(){
      const saved = localStorage.getItem(LANG_KEY);
      const start = saved || detectBrowserLang();
      applyLang(start);

      document.querySelectorAll(".lang-btn").forEach(btn => {
        btn.addEventListener("click", () => applyLang(btn.dataset.lang));
      });
    })();

    /* ========= helpers ========= */
    function money(n){ return (Math.round((Number(n||0) + Number.EPSILON) * 100)/100).toFixed(2); }
    function today(){ return new Date().toISOString().slice(0,10); }

    const LS_KEY = "ns_resit_v2";
    const SEQ_KEY = "ns_resit_seq";

    function getState(){
      try { return JSON.parse(localStorage.getItem(LS_KEY) || "{}"); } catch(e){ return {}; }
    }
    function setState(obj){ localStorage.setItem(LS_KEY, JSON.stringify(obj)); }

    function nextReceiptNo(){
      let seq = Number(localStorage.getItem(SEQ_KEY) || 0) + 1;
      localStorage.setItem(SEQ_KEY, String(seq));
      return "R-" + String(seq).padStart(4,"0");
    }

    /* ========= items ========= */
    function hookRow(tr){
      tr.querySelectorAll("input").forEach(inp=>{
        inp.addEventListener("input", ()=>{ calc(); saveDraft(); });
      });
    }

    function addRow(prefill){
      const tr=document.createElement("tr");
      tr.innerHTML=`
        <td><input class="desc" placeholder="${t("phItemDesc")}"></td>
        <td><input class="qty" type="number" min="1" value="1"></td>
        <td><input class="price" type="number" step="0.01" placeholder="0.00"></td>
        <td style="text-align:right;">
          <button class="btn-secondary" style="padding:6px 10px;" onclick="removeRow(this)">‚ùå</button>
        </td>
      `;
      document.querySelector("#itemsTable tbody").appendChild(tr);

      if(prefill){
        tr.querySelector(".desc").value = prefill.desc || "";
        tr.querySelector(".qty").value  = prefill.qty ?? 1;
        tr.querySelector(".price").value= prefill.price ?? "";
      }

      hookRow(tr);
      calc();
      saveDraft();
    }

    function removeRow(btn){
      btn.closest("tr").remove();
      if(document.querySelectorAll("#itemsTable tbody tr").length === 0) addRow();
      calc();
      saveDraft();
    }

    function clearItems(){
      document.querySelector("#itemsTable tbody").innerHTML="";
      addRow();
      calc();
      saveDraft();
    }

    /* ========= calc ========= */
    function calc(){
      let sub=0;
      const rows=[...document.querySelectorAll("#itemsTable tbody tr")];
      rows.forEach(r=>{
        const q=Number(r.querySelector(".qty").value||0);
        const p=Number(r.querySelector(".price").value||0);
        sub += q*p;
      });

      let dVal=Number(document.getElementById("discountVal").value||0);
      let dAmt = 0;
      if(document.getElementById("discountType").value==="percent"){
        dAmt = sub * (dVal/100);
      } else {
        dAmt = dVal;
      }
      if(dAmt > sub) dAmt = sub;

      let after=sub-dAmt;
      let sst = document.getElementById("sstOn").checked ? after*0.06 : 0;
      let total = after+sst;

      document.getElementById("subtotalTxt").innerText=money(sub);
      document.getElementById("discountAmtTxt").innerText=money(dAmt);
      document.getElementById("sstAmtTxt").innerText=money(sst);
      document.getElementById("grandTotalTxt").innerText=money(total);

      return {sub, dAmt, sst, total};
    }

    /* ========= save/load ========= */
    function saveDraft(){
      const rows=[...document.querySelectorAll("#itemsTable tbody tr")].map(r=>({
        desc: r.querySelector(".desc").value.trim(),
        qty:  Number(r.querySelector(".qty").value||0),
        price:Number(r.querySelector(".price").value||0)
      }));

      const state={
        biz:biz.value, bizAddr:bizAddr.value,
        docNo:docNo.value, docDate:docDate.value,
        cust:cust.value, custAddr:custAddr.value,
        payMethod:payMethod.value, payRef:payRef.value,
        discountType:discountType.value,
        discountVal:discountVal.value,
        sstOn:sstOn.checked,
        note:note.value,
        rows
      };
      setState(state);
    }

    function loadDraft(){
      const s=getState();

      biz.value = s.biz || "";
      bizAddr.value = s.bizAddr || "";
      cust.value = s.cust || "";
      custAddr.value = s.custAddr || "";
      payMethod.value = s.payMethod || "";
      payRef.value = s.payRef || "";
      note.value = s.note || "";

      discountType.value = s.discountType || "rm";
      discountVal.value = s.discountVal ?? "0";
      sstOn.checked = !!s.sstOn;

      docDate.value = s.docDate || today();
      docNo.value = s.docNo || nextReceiptNo();

      document.querySelector("#itemsTable tbody").innerHTML="";
      if(s.rows && s.rows.length){
        s.rows.forEach(r=>addRow(r));
      } else {
        addRow();
      }
      calc();
    }

    function newDoc(){
      localStorage.removeItem(LS_KEY);
      docNo.value = nextReceiptNo();
      biz.value=""; bizAddr.value="";
      cust.value=""; custAddr.value="";
      payMethod.value=""; payRef.value="";
      note.value="";
      discountType.value="rm";
      discountVal.value="0";
      sstOn.checked=false;
      docDate.value=today();
      clearItems();
      saveDraft();
    }

    /* ========= PDF ========= */
    function wrapText(doc, text, x, y, maxW, fontSize){
      doc.setFontSize(fontSize);
      const lines = doc.splitTextToSize(text, maxW);
      doc.text(lines, x, y);
      return y + lines.length * (fontSize + 2);
    }

    function generatePDF(){
      const {jsPDF}=window.jspdf;
      const doc=new jsPDF({ unit:"pt", format:"a4" });

      // ‚úÖ EVENT: download_resit
      try{
        gtag('event','download_resit',{ event_category:'tools', event_label:'resit_pdf' });
      }catch(e){}

      const pageW = doc.internal.pageSize.getWidth();
      const pageH = doc.internal.pageSize.getHeight();
      const margin = 42;
      let y = 54;

      const bizName = (biz.value || t("pdfBizFallback")).trim();
      const bizA = (bizAddr.value || "").trim();
      const custName = (cust.value || "-").trim();
      const custA = (custAddr.value || "").trim();
      const rNo = (docNo.value || "-").trim();
      const dateVal = (docDate.value || "-").trim();
      const pm = (payMethod.value || "").trim();
      const pr = (payRef.value || "").trim();
      const noteVal = (note.value || "").trim();

      // Header
      doc.setFont("helvetica","bold");
      doc.setFontSize(22);
      doc.text(t("pdfTitle"), margin, y);

      doc.setFontSize(11);
      doc.setFont("helvetica","bold");
      doc.text(t("pdfDocNo"), pageW - margin - 170, y - 10);
      doc.setFont("helvetica","normal");
      doc.text(rNo, pageW - margin, y - 10, {align:"right"});

      doc.setFont("helvetica","bold");
      doc.text(t("pdfDate"), pageW - margin - 170, y + 8);
      doc.setFont("helvetica","normal");
      doc.text(dateVal, pageW - margin, y + 8, {align:"right"});

      y += 22;
      doc.setDrawColor(220);
      doc.line(margin, y, pageW - margin, y);
      y += 18;

      // Blocks
      const leftX = margin;
      const rightX = margin + 280;

      doc.setFont("helvetica","bold");
      doc.setFontSize(11);
      doc.text(t("pdfFrom"), leftX, y);
      doc.text(t("pdfTo"), rightX, y);
      y += 14;

      doc.setFontSize(12);
      doc.text(bizName, leftX, y);
      doc.text(custName, rightX, y);
      y += 14;

      doc.setFont("helvetica","normal");
      doc.setFontSize(11);

      let yLeft = y, yRight = y;
      if(bizA) yLeft = wrapText(doc, bizA, leftX, yLeft, 250, 11) + 2;
      else yLeft += 2;

      if(custA) yRight = wrapText(doc, custA, rightX, yRight, 250, 11) + 2;
      else yRight += 2;

      y = Math.max(yLeft, yRight) + 10;

      // Payment info (optional)
      if(pm || pr){
        doc.setFont("helvetica","bold");
        doc.text(t("pdfPay"), leftX, y);
        doc.setFont("helvetica","normal");
        const payLine = [
          pm ? `${t("pdfMethod")}: ${pm}` : "",
          pr ? `${t("pdfRef")}: ${pr}` : ""
        ].filter(Boolean).join("   |   ");
        doc.text(payLine, leftX + 64, y);
        y += 18;
      } else {
        y += 10;
      }

      // Table
      const tableX = margin;
      const tableW = pageW - margin*2;
      const colDesc = Math.floor(tableW * 0.52);
      const colQty  = Math.floor(tableW * 0.12);
      const colPrice= Math.floor(tableW * 0.18);
      const colTotal= tableW - (colDesc + colQty + colPrice);

      doc.setFillColor(246, 247, 249);
      doc.setDrawColor(230);
      doc.rect(tableX, y, tableW, 26, "FD");

      doc.setFont("helvetica","bold");
      doc.setFontSize(11);
      doc.text(t("pdfDesc"), tableX + 10, y + 17);
      doc.text(t("pdfQty"), tableX + colDesc + colQty - 10, y + 17, {align:"right"});
      doc.text(t("pdfPrice"), tableX + colDesc + colQty + colPrice - 10, y + 17, {align:"right"});
      doc.text(t("pdfAmount"), tableX + tableW - 10, y + 17, {align:"right"});

      y += 34;
      doc.setFont("helvetica","normal");
      doc.setFontSize(11);

      const rows = [...document.querySelectorAll("#itemsTable tbody tr")].map(r=>({
        desc: (r.querySelector(".desc").value||"").trim(),
        qty: Number(r.querySelector(".qty").value||0),
        price: Number(r.querySelector(".price").value||0)
      })).filter(r => r.desc || r.qty || r.price);

      if(rows.length === 0) rows.push({desc:"-", qty:0, price:0});

      rows.forEach(r=>{
        const lineTotal = (r.qty || 0) * (r.price || 0);

        if(y > pageH - 180){
          doc.addPage();
          y = 60;
        }

        doc.setDrawColor(238);
        doc.line(tableX, y + 18, tableX + tableW, y + 18);

        const descLines = doc.splitTextToSize(r.desc || "-", colDesc - 20);
        doc.text(descLines, tableX + 10, y);

        doc.text(String(r.qty || 0), tableX + colDesc + colQty - 10, y, {align:"right"});
        doc.text("RM " + money(r.price || 0), tableX + colDesc + colQty + colPrice - 10, y, {align:"right"});
        doc.text("RM " + money(lineTotal || 0), tableX + tableW - 10, y, {align:"right"});

        const rowH = Math.max(20, descLines.length * 14);
        y += rowH;
      });

      y += 18;

      // Totals
      const {sub, dAmt, sst, total} = calc();
      const boxW = 280;
      const boxH = 110;
      const boxX = pageW - margin - boxW;

      if(y > pageH - boxH - 80){
        doc.addPage();
        y = 60;
      }

      doc.setDrawColor(230);
      doc.setFillColor(250, 251, 252);
      doc.rect(boxX, y, boxW, boxH, "FD");

      let ty = y + 22;
      doc.setFont("helvetica","bold");
      doc.text(t("pdfSubtotal"), boxX + 14, ty);
      doc.setFont("helvetica","normal");
      doc.text("RM " + money(sub), boxX + boxW - 14, ty, {align:"right"});

      ty += 22;
      doc.setFont("helvetica","bold");
      doc.text(t("pdfDiscount"), boxX + 14, ty);
      doc.setFont("helvetica","normal");
      doc.text("- RM " + money(dAmt), boxX + boxW - 14, ty, {align:"right"});

      ty += 22;
      doc.setFont("helvetica","bold");
      doc.text(t("pdfSst"), boxX + 14, ty);
      doc.setFont("helvetica","normal");
      doc.text("RM " + money(sst), boxX + boxW - 14, ty, {align:"right"});

      ty += 26;
      doc.setDrawColor(220);
      doc.line(boxX + 14, ty - 16, boxX + boxW - 14, ty - 16);

      doc.setFont("helvetica","bold");
      doc.setFontSize(13);
      doc.text(t("pdfTotalPaid"), boxX + 14, ty);
      doc.text("RM " + money(total), boxX + boxW - 14, ty, {align:"right"});
      doc.setFontSize(11);

      // Note
      if(noteVal){
        y = y + boxH + 22;
        doc.setFont("helvetica","bold");
        doc.text(t("pdfNote"), margin, y);
        doc.setFont("helvetica","normal");
        y += 14;
        wrapText(doc, noteVal, margin, y, pageW - margin*2, 11);
      }

      // Footer
      doc.setFontSize(9);
      doc.setTextColor(140);
      doc.text(t("pdfFooter"), margin, pageH - 24);

      const safeNo = (rNo || "receipt").replace(/[^a-z0-9-_]/gi,"_");
      doc.save(`${safeNo}.pdf`);
    }

    /* ========= listeners ========= */
    ["biz","bizAddr","cust","custAddr","payMethod","payRef","discountType","discountVal","note","docDate"].forEach(id=>{
      document.getElementById(id).addEventListener("input", ()=>{ calc(); saveDraft(); });
    });
    document.getElementById("sstOn").addEventListener("change", ()=>{ calc(); saveDraft(); });

    /* init */
    loadDraft();
    calc();
  </script>
</body>
</html>